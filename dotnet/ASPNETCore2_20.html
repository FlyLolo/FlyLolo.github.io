<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>二十.Action的数据返回格式处理 | FlyLolo 闲聊编程</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="没事敲敲代码">
    
    <link rel="preload" href="/assets/css/0.styles.b23bcaa9.css" as="style"><link rel="preload" href="/assets/js/app.5c4124d9.js" as="script"><link rel="preload" href="/assets/js/2.5052fd89.js" as="script"><link rel="preload" href="/assets/js/62.508f7c4c.js" as="script"><link rel="prefetch" href="/assets/js/10.ebd354ff.js"><link rel="prefetch" href="/assets/js/11.c0ba7b39.js"><link rel="prefetch" href="/assets/js/12.d2df4345.js"><link rel="prefetch" href="/assets/js/13.ad189de6.js"><link rel="prefetch" href="/assets/js/14.211e1c27.js"><link rel="prefetch" href="/assets/js/15.bc9f8b57.js"><link rel="prefetch" href="/assets/js/16.5cc9b653.js"><link rel="prefetch" href="/assets/js/17.4281fea3.js"><link rel="prefetch" href="/assets/js/18.1c3b6824.js"><link rel="prefetch" href="/assets/js/19.19526aaa.js"><link rel="prefetch" href="/assets/js/20.55520ac3.js"><link rel="prefetch" href="/assets/js/21.68aa2210.js"><link rel="prefetch" href="/assets/js/22.976b6f6a.js"><link rel="prefetch" href="/assets/js/23.9241ad9a.js"><link rel="prefetch" href="/assets/js/24.87e81add.js"><link rel="prefetch" href="/assets/js/25.5a324370.js"><link rel="prefetch" href="/assets/js/26.6e0c7b3a.js"><link rel="prefetch" href="/assets/js/27.c2db3589.js"><link rel="prefetch" href="/assets/js/28.f504554f.js"><link rel="prefetch" href="/assets/js/29.0b8cbb3f.js"><link rel="prefetch" href="/assets/js/3.dc0bd479.js"><link rel="prefetch" href="/assets/js/30.18cf6f70.js"><link rel="prefetch" href="/assets/js/31.90a5f0a4.js"><link rel="prefetch" href="/assets/js/32.454348da.js"><link rel="prefetch" href="/assets/js/33.1c21d0c1.js"><link rel="prefetch" href="/assets/js/34.a2fc1109.js"><link rel="prefetch" href="/assets/js/35.7123c8b5.js"><link rel="prefetch" href="/assets/js/36.6a74523e.js"><link rel="prefetch" href="/assets/js/37.4a0d5e49.js"><link rel="prefetch" href="/assets/js/38.870830b5.js"><link rel="prefetch" href="/assets/js/39.7a99876d.js"><link rel="prefetch" href="/assets/js/4.2543b7ad.js"><link rel="prefetch" href="/assets/js/40.1ab956e2.js"><link rel="prefetch" href="/assets/js/41.e2cd491a.js"><link rel="prefetch" href="/assets/js/42.8118b296.js"><link rel="prefetch" href="/assets/js/43.3b58128f.js"><link rel="prefetch" href="/assets/js/44.1648ce27.js"><link rel="prefetch" href="/assets/js/45.0e2feba0.js"><link rel="prefetch" href="/assets/js/46.8cacc6f0.js"><link rel="prefetch" href="/assets/js/47.85a42084.js"><link rel="prefetch" href="/assets/js/48.887f0baf.js"><link rel="prefetch" href="/assets/js/49.311ea494.js"><link rel="prefetch" href="/assets/js/5.82bf0454.js"><link rel="prefetch" href="/assets/js/50.1a3416b2.js"><link rel="prefetch" href="/assets/js/51.17ac5138.js"><link rel="prefetch" href="/assets/js/52.0e0119e0.js"><link rel="prefetch" href="/assets/js/53.a74775a2.js"><link rel="prefetch" href="/assets/js/54.4dc1f4cf.js"><link rel="prefetch" href="/assets/js/55.782ceae6.js"><link rel="prefetch" href="/assets/js/56.d371faac.js"><link rel="prefetch" href="/assets/js/57.42acf1f9.js"><link rel="prefetch" href="/assets/js/58.508c5ac0.js"><link rel="prefetch" href="/assets/js/59.a747c5df.js"><link rel="prefetch" href="/assets/js/6.d83b86ff.js"><link rel="prefetch" href="/assets/js/60.1a0f169d.js"><link rel="prefetch" href="/assets/js/61.eb35190d.js"><link rel="prefetch" href="/assets/js/63.4c9bbdbe.js"><link rel="prefetch" href="/assets/js/64.5f784752.js"><link rel="prefetch" href="/assets/js/65.83e85dd4.js"><link rel="prefetch" href="/assets/js/66.c3c68bbd.js"><link rel="prefetch" href="/assets/js/67.15ce6b9a.js"><link rel="prefetch" href="/assets/js/68.2f1ad103.js"><link rel="prefetch" href="/assets/js/69.e220c066.js"><link rel="prefetch" href="/assets/js/7.fbd6423b.js"><link rel="prefetch" href="/assets/js/70.024cc331.js"><link rel="prefetch" href="/assets/js/71.424df8a7.js"><link rel="prefetch" href="/assets/js/72.87abc657.js"><link rel="prefetch" href="/assets/js/73.ea6962e5.js"><link rel="prefetch" href="/assets/js/74.c50c111e.js"><link rel="prefetch" href="/assets/js/75.4d2a7dbe.js"><link rel="prefetch" href="/assets/js/76.49e30c54.js"><link rel="prefetch" href="/assets/js/77.5d8c8f6d.js"><link rel="prefetch" href="/assets/js/78.5b4f8e29.js"><link rel="prefetch" href="/assets/js/79.316dc7d8.js"><link rel="prefetch" href="/assets/js/8.a45bb22d.js"><link rel="prefetch" href="/assets/js/80.b1c365a1.js"><link rel="prefetch" href="/assets/js/81.cb25e543.js"><link rel="prefetch" href="/assets/js/82.7bc18643.js"><link rel="prefetch" href="/assets/js/83.6c0ee3d0.js"><link rel="prefetch" href="/assets/js/84.f8184dc3.js"><link rel="prefetch" href="/assets/js/85.b0a7f43e.js"><link rel="prefetch" href="/assets/js/86.af5fcb58.js"><link rel="prefetch" href="/assets/js/9.55a96ecc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b23bcaa9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="FlyLolo 闲聊编程" class="logo"> <span class="site-name can-hide">FlyLolo 闲聊编程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/dotnet/" class="nav-link router-link-active">
  .NET
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  DB
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/dotnet/" class="nav-link router-link-active">
  .NET
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  DB
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ASP.NET Core</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dotnet/" aria-current="page" class="sidebar-link">新书上市</a></li><li><a href="/dotnet/ASPNETCore2_1.html" class="sidebar-link">一. 概述</a></li><li><a href="/dotnet/ASPNETCore2_2.html" class="sidebar-link">二. 开发环境</a></li><li><a href="/dotnet/ASPNETCore2_3.html" class="sidebar-link">三. 项目结构</a></li><li><a href="/dotnet/ASPNETCore2_4.html" class="sidebar-link">四. Layout与ViewStart</a></li><li><a href="/dotnet/ASPNETCore2_5.html" class="sidebar-link">五.服务的加载与运行</a></li><li><a href="/dotnet/ASPNETCore2_6.html" class="sidebar-link">六. 聊聊依赖注入</a></li><li><a href="/dotnet/ASPNETCore2_7.html" class="sidebar-link">七.启动背后的秘密</a></li><li><a href="/dotnet/ASPNETCore2_8.html" class="sidebar-link">八.图说管道</a></li><li><a href="/dotnet/ASPNETCore2_9.html" class="sidebar-link">九.发布到CentOS</a></li><li><a href="/dotnet/ASPNETCore2_10.html" class="sidebar-link">十.升级到2.1</a></li><li><a href="/dotnet/ASPNETCore2_11.html" class="sidebar-link">十一.运行后台任务</a></li><li><a href="/dotnet/ASPNETCore2_12.html" class="sidebar-link">十二.内置日志与Nlog</a></li><li><a href="/dotnet/ASPNETCore2_13.html" class="sidebar-link">十三.httpClient.GetAsync 报SSL错误</a></li><li><a href="/dotnet/ASPNETCore2_14.html" class="sidebar-link">十四.静态文件访问与授权</a></li><li><a href="/dotnet/ASPNETCore2_15.html" class="sidebar-link">十五.图解路由(2.1 or earler)</a></li><li><a href="/dotnet/ASPNETCore2_16.html" class="sidebar-link">十六.新的Endpoint路由方案</a></li><li><a href="/dotnet/ASPNETCore2_17.html" class="sidebar-link">十七.Action的执行</a></li><li><a href="/dotnet/ASPNETCore2_18.html" class="sidebar-link">十八.Filter的处理机制及执行顺序</a></li><li><a href="/dotnet/ASPNETCore2_19.html" class="sidebar-link">十九. Action参数的映射与模型绑定</a></li><li><a href="/dotnet/ASPNETCore2_20.html" aria-current="page" class="active sidebar-link">二十.Action的数据返回格式处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/ASPNETCore2_20.html#_1-常见的返回类型" class="sidebar-link">1. 常见的返回类型</a></li><li class="sidebar-sub-header"><a href="/dotnet/ASPNETCore2_20.html#_2-内部处理机制解析" class="sidebar-link">2. 内部处理机制解析</a></li><li class="sidebar-sub-header"><a href="/dotnet/ASPNETCore2_20.html#_3-下集预告" class="sidebar-link">3. 下集预告</a></li></ul></li><li><a href="/dotnet/ASPNETCore2_21.html" class="sidebar-link">二十一. 内容协商与自定义返回格式</a></li><li><a href="/dotnet/ASPNETCore_22.html" class="sidebar-link">二十二. 多样性的配置方式</a></li><li><a href="/dotnet/ASPNETCore_23.html" class="sidebar-link">二十三. 配置的内部处理机制</a></li><li><a href="/dotnet/ASPNETCore_24.html" class="sidebar-link">二十四. Options模式的配置</a></li><li><a href="/dotnet/ASPNETCore_25.html" class="sidebar-link">二十五. TagHelper</a></li><li><a href="/dotnet/ASPNETCore2_26.html" class="sidebar-link">二十六. 应用JWT进行用户认证</a></li><li><a href="/dotnet/ASPNETCore2_27.html" class="sidebar-link">二十七. JWT与用户授权</a></li><li><a href="/dotnet/ASPNETCore_28.html" class="sidebar-link">二十八. 在Docker中部署</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>C# 其他</span> <!----></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="二十-action的数据返回格式处理"><a href="#二十-action的数据返回格式处理" class="header-anchor">#</a> 二十.Action的数据返回格式处理</h1> <hr> <p>上一章讲了系统如何将客户端提交的请求数据格式化处理成我们想要的格式并绑定到对应的参数，本章讲一下它的“逆过程”，如何将请求结果按照客户端想要的格式返回去。</p> <h2 id="_1-常见的返回类型"><a href="#_1-常见的返回类型" class="header-anchor">#</a> 1. 常见的返回类型</h2> <p>以系统模板默认生成的Home/Index这个Action来说，为什么当请求它的时候回返回一个Html页面呢？除了这之外，还有JSON、文本等类型，系统是如何处理这些不同的类型的呢？</p> <p>首先来说几种常见的返回类型的例子，并用Fiddler请求这几个例子看一下结果，涉及到的一个名为Book的类，代码为：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Book</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Code <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="a-viewresult类型"><a href="#a-viewresult类型" class="header-anchor">#</a> A.ViewResult类型</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Controller</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>返回一个Html页面，Content-Type值为： text/html; charset=utf-8</p> <h3 id="b-string类型"><a href="#b-string类型" class="header-anchor">#</a> B.string类型</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;Hello Core&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>返回字符串“Hello Core”，Content-Type值为：text/plain; charset=utf-8</p> <h3 id="c-json类型"><a href="#c-json类型" class="header-anchor">#</a> C.JSON类型</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">JsonResult</span> <span class="token function">GetJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Book</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;1001&quot;</span><span class="token punctuation">,</span> Name <span class="token operator">=</span> <span class="token string">&quot;ASP&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>返回JSON，值为：</p> <div class="language- extra-class"><pre class="language-text"><code>{&quot;code&quot;:&quot;1001&quot;,&quot;name&quot;:&quot;ASP&quot;}
</code></pre></div><p>Content-Type值为：Content-Type: application/json; charset=utf-8</p> <h3 id="d-直接返回实体类型"><a href="#d-直接返回实体类型" class="header-anchor">#</a> D.直接返回实体类型</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">Book</span> <span class="token function">GetModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Book</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;1001&quot;</span><span class="token punctuation">,</span> Name <span class="token operator">=</span> <span class="token string">&quot;ASP&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同样是返回JSON，值为：</p> <div class="language- extra-class"><pre class="language-text"><code>{&quot;code&quot;:&quot;1001&quot;,&quot;name&quot;:&quot;ASP&quot;}
</code></pre></div><p>Content-Type值同样是：Content-Type: application/json; charset=utf-8</p> <h3 id="e-void类型"><a href="#e-void类型" class="header-anchor">#</a> E.void类型</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">GetVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p>没有返回结果也没有Content-Type值。</p> <p><strong>下面看几个异步方法：</strong></p> <h3 id="f-task类型"><a href="#f-task类型" class="header-anchor">#</a> F.Task类型</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">GetTaskNoResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>与void类型一样，没有返回结果也没有Content-Type值。</p> <h3 id="g-task-string-类型"><a href="#g-task-string-类型" class="header-anchor">#</a> G.<code>Task&lt;string&gt;</code>类型</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetTaskString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> rtn <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> rtn <span class="token operator">=</span> <span class="token string">&quot;Hello Core&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> rtn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>与string类型一样，返回字符串“Hello Core”，Content-Type值为：text/plain; charset=utf-8</p> <h3 id="h-task-jsonresult-类型"><a href="#h-task-jsonresult-类型" class="header-anchor">#</a> H.<code>Task&lt;JsonResult&gt;</code>类型</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>JsonResult<span class="token punctuation">&gt;</span></span> <span class="token function">GetTaskJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">JsonResult</span> jsonResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> jsonResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Book</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;1001&quot;</span><span class="token punctuation">,</span> Name <span class="token operator">=</span> <span class="token string">&quot;ASP&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> jsonResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>与JSON类型一样，返回JSON，值为：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;code&quot;</span><span class="token operator">:</span><span class="token string">&quot;1001&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;ASP&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;code&quot;</span><span class="token operator">:</span><span class="token string">&quot;1002&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Net Core&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre></div><p>Content-Type值为：Content-Type: application/json; charset=utf-8</p> <p>还有其他类型，这里暂不列举了，总结一下：</p> <ol><li><p>返回结果有空、Html页面、普通字符串、JSON字符串几种。</p></li> <li><p>对应的Content-Type类型有空、text/html、text/plain、application/json几种。</p></li> <li><p>异步Action的返回结果，和其对应的同步Action返回结果类型一致。</p></li></ol> <p>下一节我们看一下系统是如何处理这些不同的类型的。</p> <h2 id="_2-内部处理机制解析"><a href="#_2-内部处理机制解析" class="header-anchor">#</a> 2. 内部处理机制解析</h2> <h3 id="a-总体流程"><a href="#a-总体流程" class="header-anchor">#</a> A.总体流程</h3> <p>通过下图 来看一下总体的流程：</p> <p><img src="/blogimages/ASPNETCore2_20/548134-20190910221135403-460462513.png" alt=""></p> <p>图1</p> <p>这涉及三部分内容：</p> <p>第一部分，在invoker的生成阶段。在第14章讲invoker的生成的时候，讲到了Action的执行者的获取，它是从一系列系统定义的<em>XXX</em>ResultExecutor中筛选出来的，虽然它们名为<em>XXX</em>ResultExecutor，但它们都是Action的执行者而不是ActionResult的执行者，都是ActionMethodExecutor的子类。以Action是同步还是异步以及Action的返回值类型为筛选条件，具体这部分内容见图 14‑2所示<em>XXX</em>ResultExecutor列表及其后面的筛选逻辑部分。在图 17‑1中，筛选出了被请求的Action对应的<em>XXX</em>ResultExecutor，若以Home/Index这个默认的Action为例，这个<em>XXX</em>ResultExecutor应该是SyncActionResultExecutor。</p> <p>第二部分，在Action Filters的处理阶段。这部分内容见16.5 Filter的执行，此处恰好以Action Filter为例讲了Action Filter的执行方式及Action被执行的过程。在这个阶段，会调用上文筛选出的SyncActionResultExecutor的Execute方法来执行Home/Index这个 Action。执行结果返回一个IActionResult。</p> <p>第三部分，在Result Filters的处理阶段。这个阶段和Action Filters的逻辑相似，只不过前者的核心是Action的执行，后者的核心是Action的执行结果的执行。二者都分为OnExecuting和OnExecuted两个方法，这两个方法也都在其对应的核心执行方法前后执行。</p> <p>整体流程是这样，下面看一下细节。</p> <h3 id="b-actionmethodexecutor的选择与执行"><a href="#b-actionmethodexecutor的选择与执行" class="header-anchor">#</a> B. ActionMethodExecutor的选择与执行</h3> <p>第一部分，系统为什么要定义这么多种<em>XXX</em>ResultExecutor并且在请求的时候一个个筛选合适的<em>XXX</em>ResultExecutor呢？从筛选规则是以Action的同步、异步以及Action的返回值类型来看，这么多种<em>XXX</em>ResultExecutor就是为了处理不同的Action类型。</p> <p>依然以Home/Index为例，在筛选<em>XXX</em>ResultExecutor的时候，最终返回结果是SyncActionResultExecutor。它的代码如下：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SyncActionResultExecutor</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ActionMethodExecutor</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>IActionResult<span class="token punctuation">&gt;</span></span> <span class="token function">Execute</span><span class="token punctuation">(</span>
        <span class="token class-name">IActionResultTypeMapper</span> mapper<span class="token punctuation">,</span>
        <span class="token class-name">ObjectMethodExecutor</span> executor<span class="token punctuation">,</span>
        <span class="token class-name"><span class="token keyword">object</span></span> controller<span class="token punctuation">,</span>
        <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> arguments<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> actionResult <span class="token operator">=</span> <span class="token punctuation">(</span>IActionResult<span class="token punctuation">)</span>executor<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>controller<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">EnsureActionResultNotNull</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> actionResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ValueTask<span class="token punctuation">&lt;</span>IActionResult<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>actionResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">CanExecute</span><span class="token punctuation">(</span><span class="token class-name">ObjectMethodExecutor</span> executor<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token operator">!</span>executor<span class="token punctuation">.</span>IsMethodAsync <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">IActionResult</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>executor<span class="token punctuation">.</span>MethodReturnType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><em>XXX</em>ResultExecutor的CanExecute方法是筛选的条件，通过这个方法判断它是否适合当前请求的目标Action。它要求这个Action不是异步的并且返回结果类型是派生自IActionResult的。而Home/Index这个Action标识的返回结果是IActionResult，实际是通过View()这个方法返回的，这个方法的返回结果类型实际是IActionResult的派生类ViewResult。这样的派生类还有常见的JsonResult和ContentResult等，他们都继承了ActionResult，而ActionResult实现了IActionResult接口。所以如果一个Action是同步的并且返回结果是JsonResult或ContentResult的时候，对应的<em>XXX</em>ResultExecutor也是SyncActionResultExecutor。</p> <p>第二部分中，Action的执行是在<em>XXX</em>ResultExecutor的Execute方法，它会进一步调用了ObjectMethodExecutor的Execute方法。实际上所有的Action的都是由ObjectMethodExecutor的Execute方法来执行执行的。而众多的<em>XXX</em>ResultExecutor方法的作用是调用这个方法并且对返回结果进行验证和处理。例如SyncActionResultExecutor会通过EnsureActionResultNotNull方法确保返回的结果不能为空。</p> <p>如果是sting类型呢？它对应的是SyncObjectResultExecutor，代码如下：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SyncObjectResultExecutor</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ActionMethodExecutor</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>IActionResult<span class="token punctuation">&gt;</span></span> <span class="token function">Execute</span><span class="token punctuation">(</span>
        <span class="token class-name">IActionResultTypeMapper</span> mapper<span class="token punctuation">,</span>
        <span class="token class-name">ObjectMethodExecutor</span> executor<span class="token punctuation">,</span>
        <span class="token class-name"><span class="token keyword">object</span></span> controller<span class="token punctuation">,</span>
        <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> arguments<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Sync method returning arbitrary object</span>
        <span class="token class-name"><span class="token keyword">var</span></span> returnValue <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>controller<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> actionResult <span class="token operator">=</span> <span class="token function">ConvertToActionResult</span><span class="token punctuation">(</span>mapper<span class="token punctuation">,</span> returnValue<span class="token punctuation">,</span> executor<span class="token punctuation">.</span>MethodReturnType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ValueTask<span class="token punctuation">&lt;</span>IActionResult<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>actionResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Catch-all for sync methods</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">CanExecute</span><span class="token punctuation">(</span><span class="token class-name">ObjectMethodExecutor</span> executor<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>executor<span class="token punctuation">.</span>IsMethodAsync<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>由于string不是IActionResult的子类，所以会通过ConvertToActionResult方法对返回结果returnValue进行处理。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">ConvertToActionResult</span><span class="token punctuation">(</span><span class="token class-name">IActionResultTypeMapper</span> mapper<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> returnValue<span class="token punctuation">,</span> <span class="token class-name">Type</span> declaredType<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token punctuation">(</span>returnValue <span class="token keyword">as</span> <span class="token class-name">IActionResult</span><span class="token punctuation">)</span> <span class="token operator">??</span> mapper<span class="token punctuation">.</span><span class="token function">Convert</span><span class="token punctuation">(</span>returnValue<span class="token punctuation">,</span> declaredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span>Resources<span class="token punctuation">.</span><span class="token function">FormatActionResult_ActionReturnValueCannotBeNull</span><span class="token punctuation">(</span>declaredType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</code></pre></div><p>如果returnValue是IActionResult的子类，则返回returnValue，否则调用一个Convert方法将returnValue转换一下：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Convert</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> <span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token class-name">Type</span> returnType<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>returnType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token keyword">is</span> <span class="token class-name">IConvertToActionResult</span> converter<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">.</span><span class="token function">Convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ObjectResult</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        DeclaredType <span class="token operator">=</span> returnType<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法会判断returnValue是否实现了IConvertToActionResult接口，如果是则调用该接口的Convert方法转换成IActionResult类型，否则会将returnValue封装成ObjectResult。ObjectResult也是ActionResult的子类。下文有个<code>ActionResult&lt;T&gt;</code> 类型就是这样，该例会介绍。</p> <p>所以，针对不同类型的Action，系统设置了多种<em>XXX</em>ResultExecutor来处理，最终结果无论是什么，都会被转换成IActionResult类型。方便在图 17‑1所示的第三部分进行IActionResult的执行。</p> <p>上一节列出了多种不同的Action，它们的处理在这里就不一一讲解了。通过下图 17‑2看一下它们的处理结果：</p> <p><img src="/blogimages/ASPNETCore2_20/548134-20190910221348566-1256541571.png" alt=""></p> <p>图 2</p> <p>这里有void类型没有讲到，它本身没有返回结果，但它会被赋予一个结果EmptyResult，它也是ActionResult的子类。</p> <p>图 2被两行虚线分隔为三行，第一行基本都介绍过了，第二行是第一行对应的异步方法，上一节介绍常见的返回类的时候说过，这些异步方法的返回结果和对应的同步方法是一样的。不过通过图 2可知，处理它们的<em>XXX</em>ResultExecutor方法是不一样的。</p> <p>第三行的<code>ActionResult&lt;T&gt;</code> 类型是在ASP.NET Core 2.1 引入的，它支持IActionResult的子类也支持类似string和Book这样的特定类型。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">ActionResult<span class="token punctuation">&lt;</span>TValue<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IConvertToActionResult</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">ActionResult</span><span class="token punctuation">(</span><span class="token class-name">TValue</span> <span class="token keyword">value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">IActionResult</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TValue</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> error <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">FormatInvalidTypeTForActionResultOfT</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TValue</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;ActionResult&lt;T&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Value <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">ActionResult</span><span class="token punctuation">(</span><span class="token class-name">ActionResult</span> result<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">IActionResult</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TValue</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> error <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">FormatInvalidTypeTForActionResultOfT</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TValue</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;ActionResult&lt;T&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Result <span class="token operator">=</span> result <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Gets the &lt;see cref=&quot;ActionResult&quot;/&gt;.</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult</span> Result <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Gets the value.</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">TValue</span> Value <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">implicit</span> <span class="token keyword">operator</span> <span class="token generic-method"><span class="token function">ActionResult</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TValue<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TValue</span> <span class="token keyword">value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ActionResult<span class="token punctuation">&lt;</span>TValue<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">implicit</span> <span class="token keyword">operator</span> <span class="token generic-method"><span class="token function">ActionResult</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TValue<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">ActionResult</span> result<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ActionResult<span class="token punctuation">&lt;</span>TValue<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token return-type class-name">IActionResult</span> IConvertToActionResult<span class="token punctuation">.</span><span class="token function">Convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Result <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ObjectResult</span><span class="token punctuation">(</span>Value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            DeclaredType <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TValue</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>TValue不支持IActionResult及其子类。它的值若是IActionResult子类，会被赋值给Result属性，否则会赋值给Value属性。它实现了IConvertToActionResult接口，想到刚讲解string类型被处理的时候用到的Convert方法。当返回结果实现了IConvertToActionResult这个接口的时候，就会调用它的Convert方法进行转换。它的Convert方法就是先判断它的值是否是IActionResult的子类，如果是则返回该值，否则将该值转换为ObjectResult后返回。</p> <p>所以图 2中<code>ActionResult&lt;T&gt;</code> 类型返回的结果被加上引号的意思就是结果类型可能是直接返回的IActionResult的子类,也有可能是string和Book这样的特定类型被封装后的ObjectResult类型。</p> <h3 id="c-result-filter的执行"><a href="#c-result-filter的执行" class="header-anchor">#</a> C. Result Filter的执行</h3> <p>结果被统一处理为IActionResult后，进入图 1所示的第三部分。这部分的主要内容有两个，分别是Result Filters的执行和IActionResult的执行。Result Filter也有OnResultExecuting和OnResultExecuted两个方法，分别在IActionResult执行的前后执行。</p> <p>自定义一个MyResultFilterAttribute，代码如下：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyResultFilterAttribute</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IResultFilter</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResultExecuted</span><span class="token punctuation">(</span><span class="token class-name">ResultExecutedContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Debug<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;HomeController=======&gt;OnResultExecuted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResultExecuting</span><span class="token punctuation">(</span><span class="token class-name">ResultExecutingContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Debug<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;HomeController=======&gt;OnResultExecuting&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>将它注册到第一节JSON的例子中：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MyResultFilter</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">JsonResult</span> <span class="token function">GetJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Book</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;1001&quot;</span><span class="token punctuation">,</span> Name <span class="token operator">=</span> <span class="token string">&quot;ASP&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到这样的输出结果：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>HomeController<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=&gt;</span>OnResultExecuting

……Executing JsonResult……

HomeController<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=&gt;</span>OnResultExecuted
</code></pre></div><p>在OnResultExecuting中可以通过设置context.Cancel = true;取消后面的工作的执行。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResultExecuting</span><span class="token punctuation">(</span><span class="token class-name">ResultExecutingContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//用于验证的代码略</span>
    context<span class="token punctuation">.</span>Cancel <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    Debug<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;HomeController=======&gt;OnResultExecuting&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再看输出结果就至于的输出了</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>HomeController<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=&gt;</span>OnResultExecuting
</code></pre></div><p>同时返回结果也不再是JSON值了，返回结果以及Content-Type全部为空。所以这样设置后，IActionResult以及OnResultExecuted都不再被执行。</p> <p>在这里除了可以做一些IActionResult执行之前的验证，还可以对HttpContext.Response做一些简单的操作，例如添加个Header值：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResultExecuting</span><span class="token punctuation">(</span><span class="token class-name">ResultExecutingContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;version&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1.2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Debug<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;HomeController=======&gt;OnResultExecuting&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>除了正常返回JSON结果外，Header中会出现新添加的version</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>Content<span class="token operator">-</span>Type<span class="token punctuation">:</span> application<span class="token operator">/</span>json<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf<span class="token operator">-</span><span class="token number">8</span>
version<span class="token punctuation">:</span> <span class="token number">1.2</span>
</code></pre></div><p>再看一下OnResultExecuted方法，它是在IActionResult执行之后执行。因为在这个方法执行的时候，请求结果已经发送给请求的客户端了，所以在这里可以做一些日志类的操作。举个例子，假如在这个方法中产生了异常：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResultExecuted</span><span class="token punctuation">(</span><span class="token class-name">ResultExecutedContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Debug<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;HomeController=======&gt;OnResultExecuted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>请求结果依然会返回正常的JSON，但从输出结果中看到是不一样的</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>HomeController<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=&gt;</span>OnResultExecuting
……
System<span class="token punctuation">.</span>Exception<span class="token punctuation">:</span> exception
</code></pre></div><p>发生异常，后面的Debug输出没有 执行。但却将正确的结果返回给了客户端。</p> <p>Result Filter介绍完了，看一下核心的IActionResult的执行。</p> <h3 id="d-iactionresult的执行"><a href="#d-iactionresult的执行" class="header-anchor">#</a> D. IActionResult的执行</h3> <p>在ResourceInvoker的case State.ResultInside阶段会调用IActionResult的执行方法InvokeResultAsync。该方法中参数IActionResult result会被调用ExecuteResultAsync方法执行。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeResultAsync</span><span class="token punctuation">(</span><span class="token class-name">IActionResult</span> result<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> actionContext <span class="token operator">=</span> _actionContext<span class="token punctuation">;</span>
    _diagnosticSource<span class="token punctuation">.</span><span class="token function">BeforeActionResult</span><span class="token punctuation">(</span>actionContext<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _logger<span class="token punctuation">.</span><span class="token function">BeforeExecutingActionResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> result<span class="token punctuation">.</span><span class="token function">ExecuteResultAsync</span><span class="token punctuation">(</span>actionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span>
    <span class="token punctuation">{</span>
        _diagnosticSource<span class="token punctuation">.</span><span class="token function">AfterActionResult</span><span class="token punctuation">(</span>actionContext<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _logger<span class="token punctuation">.</span><span class="token function">AfterExecutingActionResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由图 2可知，虽然所有类型的Action的结果都被转换成了IActionResult，但它们本质上还是有区别的。所以这个IActionResult类型的参数result实际上可能是JsonResult、ViewResult、EmptyResult等具体类型。下面依然以第一节JSON的例子为例来看，它返回了一个JsonResult。在这里就会调用JsonResult的ExecuteResultAsync方法，JsonResult的代码如下：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonResult</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ActionResult</span><span class="token punctuation">,</span> <span class="token class-name">IStatusCodeActionResult</span></span>
<span class="token punctuation">{</span>
    <span class="token comment">//部分代码略</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">ExecuteResultAsync</span><span class="token punctuation">(</span><span class="token class-name">ActionContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name"><span class="token keyword">var</span></span> services <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> executor <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>JsonResultExecutor<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> executor<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在它的ExecuteResultAsync方法中会获取依赖注入中设置的JsonResultExecutor，由JsonResultExecutor来调用ExecuteAsync方法执行后面的工作。JsonResultExecutor的代码如下：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonResultExecutor</span>
<span class="token punctuation">{</span>
<span class="token comment">//部分代码略</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">ExecuteAsync</span><span class="token punctuation">(</span><span class="token class-name">ActionContext</span> context<span class="token punctuation">,</span> <span class="token class-name">JsonResult</span> result<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//验证代码略</span>
        <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Response<span class="token punctuation">;</span>
    ResponseContentTypeHelper<span class="token punctuation">.</span><span class="token function">ResolveContentTypeAndEncoding</span><span class="token punctuation">(</span>
            result<span class="token punctuation">.</span>ContentType<span class="token punctuation">,</span>
            response<span class="token punctuation">.</span>ContentType<span class="token punctuation">,</span>
            DefaultContentType<span class="token punctuation">,</span>
            <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> resolvedContentType<span class="token punctuation">,</span>
            <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> resolvedContentTypeEncoding<span class="token punctuation">)</span><span class="token punctuation">;</span>

        response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> resolvedContentType<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> result<span class="token punctuation">.</span>StatusCode<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name"><span class="token keyword">var</span></span> serializerSettings <span class="token operator">=</span> result<span class="token punctuation">.</span>SerializerSettings <span class="token operator">??</span> Options<span class="token punctuation">.</span>SerializerSettings<span class="token punctuation">;</span>
        Logger<span class="token punctuation">.</span><span class="token function">JsonResultExecuting</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> writer <span class="token operator">=</span> WriterFactory<span class="token punctuation">.</span><span class="token function">CreateWriter</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>Body<span class="token punctuation">,</span> resolvedContentTypeEncoding<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> jsonWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonTextWriter</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                jsonWriter<span class="token punctuation">.</span>ArrayPool <span class="token operator">=</span> _charPool<span class="token punctuation">;</span>
                jsonWriter<span class="token punctuation">.</span>CloseOutput <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                jsonWriter<span class="token punctuation">.</span>AutoCompleteOnClose <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> jsonSerializer <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>serializerSettings<span class="token punctuation">)</span><span class="token punctuation">;</span>
                jsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>jsonWriter<span class="token punctuation">,</span> result<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            <span class="token comment">// Perf: call FlushAsync to call WriteAsync on the stream with any content left in the TextWriter's</span>
            <span class="token comment">// buffers. This is better than just letting dispose handle it (which would result in a synchronous write).</span>

            <span class="token keyword">await</span> writer<span class="token punctuation">.</span><span class="token function">FlushAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>JsonResultExecutor的ExecuteAsync方法的作用就是将JsonResult中的值转换成JSON串并写入context.HttpContext.Response. Body中。至此JsonResult执行完毕。</p> <p>ViewResult会有对应的ViewExecutor来执行，会通过相应的规则生成一个 Html页面。</p> <p>而EmptyResult的ExecuteResult方法为空，所以不会返回任何内容。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmptyResult</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ActionResult</span></span>
<span class="token punctuation">{</span>
    <span class="token comment">/// &lt;inheritdoc /&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ExecuteResult</span><span class="token punctuation">(</span><span class="token class-name">ActionContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_3-下集预告"><a href="#_3-下集预告" class="header-anchor">#</a> 3. 下集预告</h2> <ul><li><p><span style="color:#ff9900;">对于以上几种类型返回结果的格式是固定的，JsonResult就会返回JSON格式，ViewResult就会返回Html格式。</span></p></li> <li><p><span style="color:#ff9900;">但是从第一节的例子可知，string类型会返回string类型的字符串，而Book这样的实体类型却会返回JSON。</span></p></li> <li><p><span style="color:#ff9900;">由图 2可知这两种类型在执行完毕后，都被封装成了ObjectResult，那么ObjectResult在执行的时候又是如何被转换成string和JSON两种格式的呢？</span></p></li></ul> <p>下一章继续这个话题。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dotnet/ASPNETCore2_19.html" class="prev">
        十九. Action参数的映射与模型绑定
      </a></span> <span class="next"><a href="/dotnet/ASPNETCore2_21.html">
        二十一. 内容协商与自定义返回格式
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5c4124d9.js" defer></script><script src="/assets/js/2.5052fd89.js" defer></script><script src="/assets/js/62.508f7c4c.js" defer></script>
  </body>
</html>
