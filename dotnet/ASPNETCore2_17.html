<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>十七.Action的执行 | FlyLolo 闲聊编程</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="没事敲敲代码">
    
    <link rel="preload" href="/assets/css/0.styles.b23bcaa9.css" as="style"><link rel="preload" href="/assets/js/app.5c4124d9.js" as="script"><link rel="preload" href="/assets/js/2.5052fd89.js" as="script"><link rel="preload" href="/assets/js/58.508c5ac0.js" as="script"><link rel="prefetch" href="/assets/js/10.ebd354ff.js"><link rel="prefetch" href="/assets/js/11.c0ba7b39.js"><link rel="prefetch" href="/assets/js/12.d2df4345.js"><link rel="prefetch" href="/assets/js/13.ad189de6.js"><link rel="prefetch" href="/assets/js/14.211e1c27.js"><link rel="prefetch" href="/assets/js/15.bc9f8b57.js"><link rel="prefetch" href="/assets/js/16.5cc9b653.js"><link rel="prefetch" href="/assets/js/17.4281fea3.js"><link rel="prefetch" href="/assets/js/18.1c3b6824.js"><link rel="prefetch" href="/assets/js/19.19526aaa.js"><link rel="prefetch" href="/assets/js/20.55520ac3.js"><link rel="prefetch" href="/assets/js/21.68aa2210.js"><link rel="prefetch" href="/assets/js/22.976b6f6a.js"><link rel="prefetch" href="/assets/js/23.9241ad9a.js"><link rel="prefetch" href="/assets/js/24.87e81add.js"><link rel="prefetch" href="/assets/js/25.5a324370.js"><link rel="prefetch" href="/assets/js/26.6e0c7b3a.js"><link rel="prefetch" href="/assets/js/27.c2db3589.js"><link rel="prefetch" href="/assets/js/28.f504554f.js"><link rel="prefetch" href="/assets/js/29.0b8cbb3f.js"><link rel="prefetch" href="/assets/js/3.dc0bd479.js"><link rel="prefetch" href="/assets/js/30.18cf6f70.js"><link rel="prefetch" href="/assets/js/31.90a5f0a4.js"><link rel="prefetch" href="/assets/js/32.454348da.js"><link rel="prefetch" href="/assets/js/33.1c21d0c1.js"><link rel="prefetch" href="/assets/js/34.a2fc1109.js"><link rel="prefetch" href="/assets/js/35.7123c8b5.js"><link rel="prefetch" href="/assets/js/36.6a74523e.js"><link rel="prefetch" href="/assets/js/37.4a0d5e49.js"><link rel="prefetch" href="/assets/js/38.870830b5.js"><link rel="prefetch" href="/assets/js/39.7a99876d.js"><link rel="prefetch" href="/assets/js/4.2543b7ad.js"><link rel="prefetch" href="/assets/js/40.1ab956e2.js"><link rel="prefetch" href="/assets/js/41.e2cd491a.js"><link rel="prefetch" href="/assets/js/42.8118b296.js"><link rel="prefetch" href="/assets/js/43.3b58128f.js"><link rel="prefetch" href="/assets/js/44.1648ce27.js"><link rel="prefetch" href="/assets/js/45.0e2feba0.js"><link rel="prefetch" href="/assets/js/46.8cacc6f0.js"><link rel="prefetch" href="/assets/js/47.85a42084.js"><link rel="prefetch" href="/assets/js/48.887f0baf.js"><link rel="prefetch" href="/assets/js/49.311ea494.js"><link rel="prefetch" href="/assets/js/5.82bf0454.js"><link rel="prefetch" href="/assets/js/50.1a3416b2.js"><link rel="prefetch" href="/assets/js/51.17ac5138.js"><link rel="prefetch" href="/assets/js/52.0e0119e0.js"><link rel="prefetch" href="/assets/js/53.a74775a2.js"><link rel="prefetch" href="/assets/js/54.4dc1f4cf.js"><link rel="prefetch" href="/assets/js/55.782ceae6.js"><link rel="prefetch" href="/assets/js/56.d371faac.js"><link rel="prefetch" href="/assets/js/57.42acf1f9.js"><link rel="prefetch" href="/assets/js/59.a747c5df.js"><link rel="prefetch" href="/assets/js/6.d83b86ff.js"><link rel="prefetch" href="/assets/js/60.1a0f169d.js"><link rel="prefetch" href="/assets/js/61.eb35190d.js"><link rel="prefetch" href="/assets/js/62.508f7c4c.js"><link rel="prefetch" href="/assets/js/63.4c9bbdbe.js"><link rel="prefetch" href="/assets/js/64.5f784752.js"><link rel="prefetch" href="/assets/js/65.83e85dd4.js"><link rel="prefetch" href="/assets/js/66.c3c68bbd.js"><link rel="prefetch" href="/assets/js/67.15ce6b9a.js"><link rel="prefetch" href="/assets/js/68.2f1ad103.js"><link rel="prefetch" href="/assets/js/69.e220c066.js"><link rel="prefetch" href="/assets/js/7.fbd6423b.js"><link rel="prefetch" href="/assets/js/70.024cc331.js"><link rel="prefetch" href="/assets/js/71.424df8a7.js"><link rel="prefetch" href="/assets/js/72.87abc657.js"><link rel="prefetch" href="/assets/js/73.ea6962e5.js"><link rel="prefetch" href="/assets/js/74.c50c111e.js"><link rel="prefetch" href="/assets/js/75.4d2a7dbe.js"><link rel="prefetch" href="/assets/js/76.49e30c54.js"><link rel="prefetch" href="/assets/js/77.5d8c8f6d.js"><link rel="prefetch" href="/assets/js/78.5b4f8e29.js"><link rel="prefetch" href="/assets/js/79.316dc7d8.js"><link rel="prefetch" href="/assets/js/8.a45bb22d.js"><link rel="prefetch" href="/assets/js/80.b1c365a1.js"><link rel="prefetch" href="/assets/js/81.cb25e543.js"><link rel="prefetch" href="/assets/js/82.7bc18643.js"><link rel="prefetch" href="/assets/js/83.6c0ee3d0.js"><link rel="prefetch" href="/assets/js/84.f8184dc3.js"><link rel="prefetch" href="/assets/js/85.b0a7f43e.js"><link rel="prefetch" href="/assets/js/86.af5fcb58.js"><link rel="prefetch" href="/assets/js/9.55a96ecc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b23bcaa9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="FlyLolo 闲聊编程" class="logo"> <span class="site-name can-hide">FlyLolo 闲聊编程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/dotnet/" class="nav-link router-link-active">
  .NET
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  DB
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/dotnet/" class="nav-link router-link-active">
  .NET
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  DB
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ASP.NET Core</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dotnet/" aria-current="page" class="sidebar-link">新书上市</a></li><li><a href="/dotnet/ASPNETCore2_1.html" class="sidebar-link">一. 概述</a></li><li><a href="/dotnet/ASPNETCore2_2.html" class="sidebar-link">二. 开发环境</a></li><li><a href="/dotnet/ASPNETCore2_3.html" class="sidebar-link">三. 项目结构</a></li><li><a href="/dotnet/ASPNETCore2_4.html" class="sidebar-link">四. Layout与ViewStart</a></li><li><a href="/dotnet/ASPNETCore2_5.html" class="sidebar-link">五.服务的加载与运行</a></li><li><a href="/dotnet/ASPNETCore2_6.html" class="sidebar-link">六. 聊聊依赖注入</a></li><li><a href="/dotnet/ASPNETCore2_7.html" class="sidebar-link">七.启动背后的秘密</a></li><li><a href="/dotnet/ASPNETCore2_8.html" class="sidebar-link">八.图说管道</a></li><li><a href="/dotnet/ASPNETCore2_9.html" class="sidebar-link">九.发布到CentOS</a></li><li><a href="/dotnet/ASPNETCore2_10.html" class="sidebar-link">十.升级到2.1</a></li><li><a href="/dotnet/ASPNETCore2_11.html" class="sidebar-link">十一.运行后台任务</a></li><li><a href="/dotnet/ASPNETCore2_12.html" class="sidebar-link">十二.内置日志与Nlog</a></li><li><a href="/dotnet/ASPNETCore2_13.html" class="sidebar-link">十三.httpClient.GetAsync 报SSL错误</a></li><li><a href="/dotnet/ASPNETCore2_14.html" class="sidebar-link">十四.静态文件访问与授权</a></li><li><a href="/dotnet/ASPNETCore2_15.html" class="sidebar-link">十五.图解路由(2.1 or earler)</a></li><li><a href="/dotnet/ASPNETCore2_16.html" class="sidebar-link">十六.新的Endpoint路由方案</a></li><li><a href="/dotnet/ASPNETCore2_17.html" aria-current="page" class="active sidebar-link">十七.Action的执行</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/ASPNETCore2_17.html#_1-概述" class="sidebar-link">1. 概述</a></li><li class="sidebar-sub-header"><a href="/dotnet/ASPNETCore2_17.html#_2-invoker的生成" class="sidebar-link">2. invoker的生成</a></li><li class="sidebar-sub-header"><a href="/dotnet/ASPNETCore2_17.html#_3-invoker的执行" class="sidebar-link">3. invoker的执行</a></li></ul></li><li><a href="/dotnet/ASPNETCore2_18.html" class="sidebar-link">十八.Filter的处理机制及执行顺序</a></li><li><a href="/dotnet/ASPNETCore2_19.html" class="sidebar-link">十九. Action参数的映射与模型绑定</a></li><li><a href="/dotnet/ASPNETCore2_20.html" class="sidebar-link">二十.Action的数据返回格式处理</a></li><li><a href="/dotnet/ASPNETCore2_21.html" class="sidebar-link">二十一. 内容协商与自定义返回格式</a></li><li><a href="/dotnet/ASPNETCore_22.html" class="sidebar-link">二十二. 多样性的配置方式</a></li><li><a href="/dotnet/ASPNETCore_23.html" class="sidebar-link">二十三. 配置的内部处理机制</a></li><li><a href="/dotnet/ASPNETCore_24.html" class="sidebar-link">二十四. Options模式的配置</a></li><li><a href="/dotnet/ASPNETCore_25.html" class="sidebar-link">二十五. TagHelper</a></li><li><a href="/dotnet/ASPNETCore2_26.html" class="sidebar-link">二十六. 应用JWT进行用户认证</a></li><li><a href="/dotnet/ASPNETCore2_27.html" class="sidebar-link">二十七. JWT与用户授权</a></li><li><a href="/dotnet/ASPNETCore_28.html" class="sidebar-link">二十八. 在Docker中部署</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>C# 其他</span> <!----></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="十七-action的执行"><a href="#十七-action的执行" class="header-anchor">#</a> 十七.Action的执行</h1> <p>上一章介绍了经过路由的处理，一个请求找到了具体处理这个请求的EndPoint，并最终执行它的RequestDelegate方法来处理这个Httpcontext。本章继续这个处理进程，按照惯例，依然通过几幅图来聊一聊这个RequestDelegate之后的故事。在此就避免不了的聊到各种Filter，它方便我们在action执行的前后做一些 “小动作”。</p> <h2 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> 1. 概述</h2> <p>首先看一下RequestDelegate这个方法：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">RequestDelegate</span> requestDelegate <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> routeData <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">GetRouteData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> actionContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ActionContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> routeData<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> invoker <span class="token operator">=</span> _invokerFactory<span class="token punctuation">.</span><span class="token function">CreateInvoker</span><span class="token punctuation">(</span>actionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>将这个方法的内容分为两部分：</p> <p>A. invoker的生成，前三句，通过CreateInvoker方法生成了一个invoker，它是一个比较复杂的综合体，包含了controller的创建工厂、参数的绑定方法以及本action相关的各种Filter的集合等， 也就是说它是前期准备工作阶段，这个阶段扩展开来涉及面比较广，在下文详细描述。</p> <p>B.invoker的执行，最后一句，前面已经万事俱备，准备了好多方法，到此来执行。此时涉及到前面准备的各种方法的执行，各种Filter也在此时被执行。</p> <h2 id="_2-invoker的生成"><a href="#_2-invoker的生成" class="header-anchor">#</a> 2. invoker的生成</h2> <p>依照习惯，还是通过流程图来看一看：</p> <p><a href="/blogimages/ASPNETCore2_17/548134-20190125115548360-1143760105.png"><img src="/blogimages/ASPNETCore2_17/548134-20190125115548360-1143760105.png" alt=""></a></p> <p>图一（<a href="/blogimages/ASPNETCore2_17/548134-20190125115548360-1143760105.png">点击查看大图</a>）</p> <p>首先说一下此图的结构，每个泳道相当于是上一个泳道中的<img src="/blogimages/ASPNETCore2_17/548134-20190124164750728-608923653.jpg" alt="">图标的细化说明，例如第二条泳道是图标<span style="color:#ff0000;">①</span>标识的方块的明细化。</p> <h3 id="a-泳道一"><a href="#a-泳道一" class="header-anchor">#</a> A. 泳道一：</h3> <p>就是第一节【概述】中描述的的内容，不再赘述。另外提一下本文的核心invoker本质上就是一个ControllerActionInvoker，也是图中的ActionInvokerProviderContext.Result。</p> <h3 id="b-泳道二-即1的详细描述"><a href="#b-泳道二-即1的详细描述" class="header-anchor">#</a> B.泳道二：即①的详细描述</h3> <p><strong>① ActionInvokerFactory.CreateInvoker(actionContext)</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token number">1</span> <span class="token keyword">public</span> <span class="token return-type class-name">IActionInvoker</span> <span class="token function">CreateInvoker</span><span class="token punctuation">(</span><span class="token class-name">ActionContext</span> actionContext<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{</span>
<span class="token number">3</span>     <span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ActionInvokerProviderContext</span><span class="token punctuation">(</span>actionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4</span> 
<span class="token number">5</span>     <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> provider <span class="token keyword">in</span> _actionInvokerProviders<span class="token punctuation">)</span>
<span class="token number">6</span>     <span class="token punctuation">{</span>
<span class="token number">7</span>         provider<span class="token punctuation">.</span><span class="token function">OnProvidersExecuting</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">8</span>     <span class="token punctuation">}</span>
<span class="token number">9</span> 
<span class="token number">10</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> i <span class="token operator">=</span> _actionInvokerProviders<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span>
<span class="token number">11</span>     <span class="token punctuation">{</span>
<span class="token number">12</span>         _actionInvokerProviders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">OnProvidersExecuted</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span>     <span class="token punctuation">}</span>
<span class="token number">14</span> 
<span class="token number">15</span>     <span class="token keyword">return</span> context<span class="token punctuation">.</span>Result<span class="token punctuation">;</span>
<span class="token number">16</span> <span class="token punctuation">}</span>
</code></pre></div><p>本章设计的这部分内容比较常见的一个操作就是context的封装，这从第一个泳道的第一个操作就开始了， 他将HttpContext、RouteData，ActionDescriptor封装到一起成了一个<strong>ActionContext ，<strong>而到了这个方法，又将这个</strong>ActionContext</strong> 封装成了<strong>ActionInvokerProviderContext，<strong>接下来就是遍历_actionInvokerProviders调用它们的OnProvidersExecuting和OnProvidersExecuted方法来设置</strong>ActionInvokerProviderContext</strong>.Result，也就是最终的ControllerActionInvoker。</p> <p>这里说一下_actionInvokerProviders，它的类型是IActionInvokerProvider[]，默认情况下包含了两个，分别是ControllerActionInvokerProvider和PageActionInvokerProvider，第一个是用于MVC的action的处理，而第二个用于Razor Pages Web的处理。二者的OnProvidersExecuting方法都会首先判断当前action是不是自己对应的类型，若不是则直接跳过。二者的OnProvidersExecuted方法目前均为空。<span style="color:#ff6600;">所以图中和下面关于OnProvidersExecuting的描述也仅限于ControllerActionInvokerProvider的OnProvidersExecuting方法。</span></p> <h3 id="c-泳道三-controlleractioninvokerprovider-onprovidersexecuting-context"><a href="#c-泳道三-controlleractioninvokerprovider-onprovidersexecuting-context" class="header-anchor">#</a> C.泳道三：ControllerActionInvokerProvider.OnProvidersExecuting(context)</h3> <p><strong>即泳道二中的③的详细描述</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token number">1</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnProvidersExecuting</span><span class="token punctuation">(</span><span class="token class-name">ActionInvokerProviderContext</span> context<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{</span>
<span class="token number">3</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>ActionContext<span class="token punctuation">.</span>ActionDescriptor <span class="token keyword">is</span> <span class="token class-name">ControllerActionDescriptor</span><span class="token punctuation">)</span>
<span class="token number">4</span>     <span class="token punctuation">{</span>
<span class="token number">5</span>         <span class="token class-name"><span class="token keyword">var</span></span> controllerContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ControllerContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>ActionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6</span>         <span class="token comment">// PERF: These are rarely going to be changed, so let's go copy-on-write.</span>
<span class="token number">7</span>         controllerContext<span class="token punctuation">.</span>ValueProviderFactories <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CopyOnWriteList<span class="token punctuation">&lt;</span>IValueProviderFactory<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>_valueProviderFactories<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">8</span>         controllerContext<span class="token punctuation">.</span>ModelState<span class="token punctuation">.</span>MaxAllowedErrors <span class="token operator">=</span> _maxModelValidationErrors<span class="token punctuation">;</span>
<span class="token number">9</span> 
<span class="token number">10</span>         <span class="token class-name"><span class="token keyword">var</span></span> cacheResult <span class="token operator">=</span> _controllerActionInvokerCache<span class="token punctuation">.</span><span class="token function">GetCachedResult</span><span class="token punctuation">(</span>controllerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">11</span> 
<span class="token number">12</span>         <span class="token class-name"><span class="token keyword">var</span></span> invoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ControllerActionInvoker</span><span class="token punctuation">(</span>
<span class="token number">13</span>             _logger<span class="token punctuation">,</span>
<span class="token number">14</span>             _diagnosticSource<span class="token punctuation">,</span>
<span class="token number">15</span>             _mapper<span class="token punctuation">,</span>
<span class="token number">16</span>             controllerContext<span class="token punctuation">,</span>
<span class="token number">17</span>             cacheResult<span class="token punctuation">.</span>cacheEntry<span class="token punctuation">,</span>
<span class="token number">18</span>             cacheResult<span class="token punctuation">.</span>filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">19</span> 
<span class="token number">20</span>         context<span class="token punctuation">.</span>Result <span class="token operator">=</span> invoker<span class="token punctuation">;</span>
<span class="token number">21</span>     <span class="token punctuation">}</span>
<span class="token number">22</span> <span class="token punctuation">}</span>
</code></pre></div><p>如上文所述，在处理之前，首先就是判断当前action是否是自己对应处理的类型。然后就是继续封装大法，将ActionContext封装成了ControllerContext。进而是调用GetCachedResult方法读取两个关键内容cacheResult.cacheEntry和cacheResult.filters后，将其封装成ControllerActionInvoker（⑤）。</p> <h3 id="d-第四条泳道"><a href="#d-第四条泳道" class="header-anchor">#</a> D.第四条泳道：</h3> <p>对应的是第三条中的④<strong>ControllerActionInvokerCache.GetCachedResult(controllerContext);</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token number">1</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token punctuation">(</span>ControllerActionInvokerCacheEntry cacheEntry<span class="token punctuation">,</span> IFilterMetadata<span class="token punctuation">[</span><span class="token punctuation">]</span> filters<span class="token punctuation">)</span></span> <span class="token function">GetCachedResult</span><span class="token punctuation">(</span><span class="token class-name">ControllerContext</span> controllerContext<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{</span>
<span class="token number">3</span>     <span class="token class-name"><span class="token keyword">var</span></span> cache <span class="token operator">=</span> CurrentCache<span class="token punctuation">;</span>
<span class="token number">4</span>     <span class="token class-name"><span class="token keyword">var</span></span> actionDescriptor <span class="token operator">=</span> controllerContext<span class="token punctuation">.</span>ActionDescriptor<span class="token punctuation">;</span>
<span class="token number">5</span> 
<span class="token number">6</span>     <span class="token class-name">IFilterMetadata<span class="token punctuation">[</span><span class="token punctuation">]</span></span> filters<span class="token punctuation">;</span>
<span class="token number">7</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cache<span class="token punctuation">.</span>Entries<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>actionDescriptor<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> cacheEntry<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">8</span>     <span class="token punctuation">{</span>
<span class="token number">9</span>         <span class="token class-name"><span class="token keyword">var</span></span> filterFactoryResult <span class="token operator">=</span> FilterFactory<span class="token punctuation">.</span><span class="token function">GetAllFilters</span><span class="token punctuation">(</span>_filterProviders<span class="token punctuation">,</span> controllerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10</span>         filters <span class="token operator">=</span> filterFactoryResult<span class="token punctuation">.</span>Filters<span class="token punctuation">;</span>
<span class="token number">11</span> 
<span class="token number">12</span>         <span class="token class-name"><span class="token keyword">var</span></span> parameterDefaultValues <span class="token operator">=</span> ParameterDefaultValues
<span class="token number">13</span>             <span class="token punctuation">.</span><span class="token function">GetParameterDefaultValues</span><span class="token punctuation">(</span>actionDescriptor<span class="token punctuation">.</span>MethodInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">14</span> 
<span class="token number">15</span>         <span class="token class-name"><span class="token keyword">var</span></span> objectMethodExecutor <span class="token operator">=</span> ObjectMethodExecutor<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>
<span class="token number">16</span>             actionDescriptor<span class="token punctuation">.</span>MethodInfo<span class="token punctuation">,</span>
<span class="token number">17</span>             actionDescriptor<span class="token punctuation">.</span>ControllerTypeInfo<span class="token punctuation">,</span>
<span class="token number">18</span>             parameterDefaultValues<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">19</span> 
<span class="token number">20</span>         <span class="token class-name"><span class="token keyword">var</span></span> controllerFactory <span class="token operator">=</span> _controllerFactoryProvider<span class="token punctuation">.</span><span class="token function">CreateControllerFactory</span><span class="token punctuation">(</span>actionDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">21</span>         <span class="token class-name"><span class="token keyword">var</span></span> controllerReleaser <span class="token operator">=</span> _controllerFactoryProvider<span class="token punctuation">.</span><span class="token function">CreateControllerReleaser</span><span class="token punctuation">(</span>actionDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">22</span>         <span class="token class-name"><span class="token keyword">var</span></span> propertyBinderFactory <span class="token operator">=</span> ControllerBinderDelegateProvider<span class="token punctuation">.</span><span class="token function">CreateBinderDelegate</span><span class="token punctuation">(</span>
<span class="token number">23</span>             _parameterBinder<span class="token punctuation">,</span>
<span class="token number">24</span>             _modelBinderFactory<span class="token punctuation">,</span>
<span class="token number">25</span>             _modelMetadataProvider<span class="token punctuation">,</span>
<span class="token number">26</span>             actionDescriptor<span class="token punctuation">,</span>
<span class="token number">27</span>             _mvcOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">28</span> 
<span class="token number">29</span>         <span class="token class-name"><span class="token keyword">var</span></span> actionMethodExecutor <span class="token operator">=</span> ActionMethodExecutor<span class="token punctuation">.</span><span class="token function">GetExecutor</span><span class="token punctuation">(</span>objectMethodExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">30</span> 
<span class="token number">31</span>         cacheEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ControllerActionInvokerCacheEntry</span><span class="token punctuation">(</span>
<span class="token number">32</span>             filterFactoryResult<span class="token punctuation">.</span>CacheableFilters<span class="token punctuation">,</span>
<span class="token number">33</span>             controllerFactory<span class="token punctuation">,</span>
<span class="token number">34</span>             controllerReleaser<span class="token punctuation">,</span>
<span class="token number">35</span>             propertyBinderFactory<span class="token punctuation">,</span>
<span class="token number">36</span>             objectMethodExecutor<span class="token punctuation">,</span>
<span class="token number">37</span>             actionMethodExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">38</span>         cacheEntry <span class="token operator">=</span> cache<span class="token punctuation">.</span>Entries<span class="token punctuation">.</span><span class="token function">GetOrAdd</span><span class="token punctuation">(</span>actionDescriptor<span class="token punctuation">,</span> cacheEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">39</span>     <span class="token punctuation">}</span>
<span class="token number">40</span>     <span class="token keyword">else</span>
<span class="token number">41</span>     <span class="token punctuation">{</span>
<span class="token number">42</span>         <span class="token comment">// Filter instances from statically defined filter descriptors + from filter providers</span>
<span class="token number">43</span>         filters <span class="token operator">=</span> FilterFactory<span class="token punctuation">.</span><span class="token function">CreateUncachedFilters</span><span class="token punctuation">(</span>_filterProviders<span class="token punctuation">,</span> controllerContext<span class="token punctuation">,</span> cacheEntry<span class="token punctuation">.</span>CachedFilters<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">44</span>     <span class="token punctuation">}</span>
<span class="token number">45</span> 
<span class="token number">46</span>     <span class="token keyword">return</span> <span class="token punctuation">(</span>cacheEntry<span class="token punctuation">,</span> filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>总的来看，本段内容主要是为了组装cacheEntry和 filters两个内容，而一个大的 if 体现出这里加入了缓存机制，使系统不必每次都去拼凑这些，提高执行效率。</p> <p>⑥IFilterMetadata[] filters，它是一个filter的集和，首先调用FilterFactory的GetAllFilters(_filterProviders, controllerContext)方法获取当前action对应的所有Filte<span style="color:#000000;">r并对这些Filter进行排序（Filter部分将在之后章节分享）。</span></p> <p><span style="color:#000000;">接下来就是组装⑦cacheEntry，它的内容比较多，比较重要的几个有：⑧ controllerFactory和controllerReleaser他们的本质都是Func&lt;ControllerContext, object&gt;，也就是Controller的Create和Release方法。 ⑨propertyBinderFactory 是一个用于参数绑定的Task，可以说也是一个组装好准备被执行的方法。最后一个⑩actionMethodExecutor也就是执行者，通过ActionMethodExecutor.GetExecutor(objectMethodExecutor)方法从众多的action执行者（如图二）中找出一个当前action对应的执行者出来。</span></p> <p><span style="color:#000000;"><img src="/blogimages/ASPNETCore2_17/548134-20190125100104654-1468029255.jpg" alt=""></span></p> <p><span style="color:#000000;">                                                             图二</span></p> <p><span style="color:#ff6600;"><strong>总结: 本节invoker的生成，总的来说就是一个执行前“万事俱备”的过程，invoker是一个组装起来的集合，它包含一个人（<strong>执行者actionMethodExecutor</strong>）、N把枪（<strong>组装好用于“被执行”的方法例如controllerFactory、controllerReleaser和propertyBinderFactory，当然还有个filter的集和</strong>）。由此也可以进一步想到，接下来的过程就是这些准备好的内容按照一定的顺序逐步执行的过程。</strong></span></p> <h2 id="_3-invoker的执行"><a href="#_3-invoker的执行" class="header-anchor">#</a> 3. invoker的执行</h2> <p>invoker的执行也就是invoker.InvokeAsync()，虽然invoker本质上是ControllerActionInvoker，但这个方法写在ResourceInvoker类中， <code>ControllerActionInvoker : &lt;span style=&quot;color: #0000ff;&quot;&gt;ResourceInvoker, IActionInvoker</code> 。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">InvokeFilterPipelineAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span>
    <span class="token punctuation">{</span>
        <span class="token function">ReleaseResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _logger<span class="token punctuation">.</span><span class="token function">ExecutedAction</span><span class="token punctuation">(</span>_actionContext<span class="token punctuation">.</span>ActionDescriptor<span class="token punctuation">,</span> stopwatch<span class="token punctuation">.</span><span class="token function">GetElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeFilterPipelineAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> next <span class="token operator">=</span> State<span class="token punctuation">.</span>InvokeBegin<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> scope <span class="token operator">=</span> Scope<span class="token punctuation">.</span>Invoker<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> state <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">object</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// `isCompleted` will be set to true when we've reached a terminal state.</span>
    <span class="token class-name"><span class="token keyword">var</span></span> isCompleted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCompleted<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token keyword">ref</span> next<span class="token punctuation">,</span> <span class="token keyword">ref</span> scope<span class="token punctuation">,</span> <span class="token keyword">ref</span> state<span class="token punctuation">,</span> <span class="token keyword">ref</span> isCompleted<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看似比较简单的两个方法，从InvokeAsync方法中可以看出来，请求会进入筛选器管道进行处理，也就是 <code>Task InvokeFilterPipelineAsync()</code> 方法，借用官方文档中的一个图看一下</p> <p><img src="/blogimages/ASPNETCore2_17/548134-20190125112326288-1119304777.png" alt=""></p> <p>图三</p> <p>此图描述了请求经过其他中间件处理后，进入路由处理最终找到了对应的action，最终进入筛选器管道进行处理。而这个处理的核心部分就是方法中的 <code>while(!isCompleted)</code> 循环，它对应的Next方法比较长，如下（较长已折叠）</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token return-type class-name">Task</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">State</span> next<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name">Scope</span> scope<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name"><span class="token keyword">object</span></span> state<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name"><span class="token keyword">bool</span></span> isCompleted<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> State<span class="token punctuation">.</span>InvokeBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationBegin<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                _cursor<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationNext<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationNext<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> current <span class="token operator">=</span> _cursor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetNextFilter</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAuthorizationFilter<span class="token punctuation">,</span> IAsyncAuthorizationFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>FilterAsync <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_authorizationContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        _authorizationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AuthorizationFilterContext</span><span class="token punctuation">(</span>_actionContext<span class="token punctuation">,</span> _filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    state <span class="token operator">=</span> current<span class="token punctuation">.</span>FilterAsync<span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationAsyncBegin<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>Filter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_authorizationContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        _authorizationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AuthorizationFilterContext</span><span class="token punctuation">(</span>_actionContext<span class="token punctuation">,</span> _filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    state <span class="token operator">=</span> current<span class="token punctuation">.</span>Filter<span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationSync<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationEnd<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationAsyncBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_authorizationContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IAsyncAuthorizationFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> authorizationContext <span class="token operator">=</span> _authorizationContext<span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">BeforeOnAuthorizationAsync</span><span class="token punctuation">(</span>authorizationContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">BeforeExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    FilterTypeConstants<span class="token punctuation">.</span>AuthorizationFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IAsyncAuthorizationFilter<span class="token punctuation">.</span>OnAuthorizationAsync<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">OnAuthorizationAsync</span><span class="token punctuation">(</span>authorizationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>AuthorizationAsyncEnd<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationAsyncEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationAsyncEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_authorizationContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IAsyncAuthorizationFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> authorizationContext <span class="token operator">=</span> _authorizationContext<span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">AfterOnAuthorizationAsync</span><span class="token punctuation">(</span>authorizationContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">AfterExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    FilterTypeConstants<span class="token punctuation">.</span>AuthorizationFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IAsyncAuthorizationFilter<span class="token punctuation">.</span>OnAuthorizationAsync<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>authorizationContext<span class="token punctuation">.</span>Result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationShortCircuit<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationNext<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationSync<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_authorizationContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IAuthorizationFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> authorizationContext <span class="token operator">=</span> _authorizationContext<span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">BeforeOnAuthorization</span><span class="token punctuation">(</span>authorizationContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">BeforeExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    FilterTypeConstants<span class="token punctuation">.</span>AuthorizationFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IAuthorizationFilter<span class="token punctuation">.</span>OnAuthorization<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                filter<span class="token punctuation">.</span><span class="token function">OnAuthorization</span><span class="token punctuation">(</span>authorizationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">AfterOnAuthorization</span><span class="token punctuation">(</span>authorizationContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">AfterExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    FilterTypeConstants<span class="token punctuation">.</span>AuthorizationFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IAuthorizationFilter<span class="token punctuation">.</span>OnAuthorization<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>authorizationContext<span class="token punctuation">.</span>Result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationShortCircuit<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationNext<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationShortCircuit<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_authorizationContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_authorizationContext<span class="token punctuation">.</span>Result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                _logger<span class="token punctuation">.</span><span class="token function">AuthorizationFailure</span><span class="token punctuation">(</span><span class="token punctuation">(</span>IFilterMetadata<span class="token punctuation">)</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// This is a short-circuit - execute relevant result filters + result and complete this invocation.</span>
                isCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                _result <span class="token operator">=</span> _authorizationContext<span class="token punctuation">.</span>Result<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">InvokeAlwaysRunResultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>AuthorizationEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceBegin<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                _cursor<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceNext<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceNext<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> current <span class="token operator">=</span> _cursor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetNextFilter</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IResourceFilter<span class="token punctuation">,</span> IAsyncResourceFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>FilterAsync <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_resourceExecutingContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        _resourceExecutingContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ResourceExecutingContext</span><span class="token punctuation">(</span>
                            _actionContext<span class="token punctuation">,</span>
                            _filters<span class="token punctuation">,</span>
                            _valueProviderFactories<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    state <span class="token operator">=</span> current<span class="token punctuation">.</span>FilterAsync<span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceAsyncBegin<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>Filter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_resourceExecutingContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        _resourceExecutingContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ResourceExecutingContext</span><span class="token punctuation">(</span>
                            _actionContext<span class="token punctuation">,</span>
                            _filters<span class="token punctuation">,</span>
                            _valueProviderFactories<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    state <span class="token operator">=</span> current<span class="token punctuation">.</span>Filter<span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceSyncBegin<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// All resource filters are currently on the stack - now execute the 'inside'.</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceInside<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceAsyncBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_resourceExecutingContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IAsyncResourceFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> resourceExecutingContext <span class="token operator">=</span> _resourceExecutingContext<span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">BeforeOnResourceExecution</span><span class="token punctuation">(</span>resourceExecutingContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">BeforeExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    FilterTypeConstants<span class="token punctuation">.</span>ResourceFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IAsyncResourceFilter<span class="token punctuation">.</span>OnResourceExecutionAsync<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">OnResourceExecutionAsync</span><span class="token punctuation">(</span>resourceExecutingContext<span class="token punctuation">,</span> InvokeNextResourceFilterAwaitedAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ResourceAsyncEnd<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceAsyncEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceAsyncEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_resourceExecutingContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IAsyncResourceFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_resourceExecutedContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// If we get here then the filter didn't call 'next' indicating a short circuit.</span>
                    _resourceExecutedContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ResourceExecutedContext</span><span class="token punctuation">(</span>_resourceExecutingContext<span class="token punctuation">,</span> _filters<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        Canceled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        Result <span class="token operator">=</span> _resourceExecutingContext<span class="token punctuation">.</span>Result<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>

                    _diagnosticSource<span class="token punctuation">.</span><span class="token function">AfterOnResourceExecution</span><span class="token punctuation">(</span>_resourceExecutedContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _logger<span class="token punctuation">.</span><span class="token function">AfterExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                        FilterTypeConstants<span class="token punctuation">.</span>ResourceFilter<span class="token punctuation">,</span>
                        <span class="token keyword">nameof</span><span class="token punctuation">(</span>IAsyncResourceFilter<span class="token punctuation">.</span>OnResourceExecutionAsync<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// A filter could complete a Task without setting a result</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_resourceExecutingContext<span class="token punctuation">.</span>Result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceShortCircuit<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceSyncBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_resourceExecutingContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IResourceFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> resourceExecutingContext <span class="token operator">=</span> _resourceExecutingContext<span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">BeforeOnResourceExecuting</span><span class="token punctuation">(</span>resourceExecutingContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">BeforeExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    FilterTypeConstants<span class="token punctuation">.</span>ResourceFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IResourceFilter<span class="token punctuation">.</span>OnResourceExecuting<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                filter<span class="token punctuation">.</span><span class="token function">OnResourceExecuting</span><span class="token punctuation">(</span>resourceExecutingContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">AfterOnResourceExecuting</span><span class="token punctuation">(</span>resourceExecutingContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">AfterExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    FilterTypeConstants<span class="token punctuation">.</span>ResourceFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IResourceFilter<span class="token punctuation">.</span>OnResourceExecuting<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceExecutingContext<span class="token punctuation">.</span>Result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    _resourceExecutedContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ResourceExecutedContext</span><span class="token punctuation">(</span>resourceExecutingContext<span class="token punctuation">,</span> _filters<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        Canceled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        Result <span class="token operator">=</span> _resourceExecutingContext<span class="token punctuation">.</span>Result<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>

                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceShortCircuit<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">InvokeNextResourceFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ResourceSyncEnd<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceSyncEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceSyncEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_resourceExecutingContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_resourceExecutedContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IResourceFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> resourceExecutedContext <span class="token operator">=</span> _resourceExecutedContext<span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">BeforeOnResourceExecuted</span><span class="token punctuation">(</span>resourceExecutedContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">BeforeExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    FilterTypeConstants<span class="token punctuation">.</span>ResourceFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IResourceFilter<span class="token punctuation">.</span>OnResourceExecuted<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                filter<span class="token punctuation">.</span><span class="token function">OnResourceExecuted</span><span class="token punctuation">(</span>resourceExecutedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">AfterOnResourceExecuted</span><span class="token punctuation">(</span>resourceExecutedContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">AfterExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    FilterTypeConstants<span class="token punctuation">.</span>ResourceFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IResourceFilter<span class="token punctuation">.</span>OnResourceExecuted<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceShortCircuit<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_resourceExecutingContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_resourceExecutedContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                _logger<span class="token punctuation">.</span><span class="token function">ResourceFilterShortCircuited</span><span class="token punctuation">(</span><span class="token punctuation">(</span>IFilterMetadata<span class="token punctuation">)</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>

                _result <span class="token operator">=</span> _resourceExecutingContext<span class="token punctuation">.</span>Result<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">InvokeAlwaysRunResultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ResourceEnd<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceInside<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionBegin<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                _cursor<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionNext<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionNext<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> current <span class="token operator">=</span> _cursor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetNextFilter</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IExceptionFilter<span class="token punctuation">,</span> IAsyncExceptionFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>FilterAsync <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    state <span class="token operator">=</span> current<span class="token punctuation">.</span>FilterAsync<span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionAsyncBegin<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>Filter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    state <span class="token operator">=</span> current<span class="token punctuation">.</span>Filter<span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionSyncBegin<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> Scope<span class="token punctuation">.</span>Exception<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// All exception filters are on the stack already - so execute the 'inside'.</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionInside<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// There are no exception filters - so jump right to the action.</span>
                    Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>scope <span class="token operator">==</span> Scope<span class="token punctuation">.</span>Invoker <span class="token operator">||</span> scope <span class="token operator">==</span> Scope<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionBegin<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionAsyncBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">InvokeNextExceptionFilterAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ExceptionAsyncResume<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionAsyncResume<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionAsyncResume<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IAsyncExceptionFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> exceptionContext <span class="token operator">=</span> _exceptionContext<span class="token punctuation">;</span>

                <span class="token comment">// When we get here we're 'unwinding' the stack of exception filters. If we have an unhandled exception,</span>
                <span class="token comment">// we'll call the filter. Otherwise there's nothing to do.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>exceptionContext<span class="token punctuation">?.</span>Exception <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>exceptionContext<span class="token punctuation">.</span>ExceptionHandled<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    _diagnosticSource<span class="token punctuation">.</span><span class="token function">BeforeOnExceptionAsync</span><span class="token punctuation">(</span>exceptionContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _logger<span class="token punctuation">.</span><span class="token function">BeforeExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                        FilterTypeConstants<span class="token punctuation">.</span>ExceptionFilter<span class="token punctuation">,</span>
                        <span class="token keyword">nameof</span><span class="token punctuation">(</span>IAsyncExceptionFilter<span class="token punctuation">.</span>OnExceptionAsync<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">OnExceptionAsync</span><span class="token punctuation">(</span>exceptionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        next <span class="token operator">=</span> State<span class="token punctuation">.</span>ExceptionAsyncEnd<span class="token punctuation">;</span>
                        <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionAsyncEnd<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionAsyncEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_exceptionContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IAsyncExceptionFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> exceptionContext <span class="token operator">=</span> _exceptionContext<span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">AfterOnExceptionAsync</span><span class="token punctuation">(</span>exceptionContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">AfterExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    FilterTypeConstants<span class="token punctuation">.</span>ExceptionFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IAsyncExceptionFilter<span class="token punctuation">.</span>OnExceptionAsync<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>exceptionContext<span class="token punctuation">.</span>Exception <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> exceptionContext<span class="token punctuation">.</span>ExceptionHandled<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// We don't need to do anything to trigger a short circuit. If there's another</span>
                    <span class="token comment">// exception filter on the stack it will check the same set of conditions</span>
                    <span class="token comment">// and then just skip itself.</span>
                    _logger<span class="token punctuation">.</span><span class="token function">ExceptionFilterShortCircuited</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionSyncBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">InvokeNextExceptionFilterAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ExceptionSyncEnd<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionSyncEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionSyncEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IExceptionFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> exceptionContext <span class="token operator">=</span> _exceptionContext<span class="token punctuation">;</span>

                <span class="token comment">// When we get here we're 'unwinding' the stack of exception filters. If we have an unhandled exception,</span>
                <span class="token comment">// we'll call the filter. Otherwise there's nothing to do.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>exceptionContext<span class="token punctuation">?.</span>Exception <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>exceptionContext<span class="token punctuation">.</span>ExceptionHandled<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    _diagnosticSource<span class="token punctuation">.</span><span class="token function">BeforeOnException</span><span class="token punctuation">(</span>exceptionContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _logger<span class="token punctuation">.</span><span class="token function">BeforeExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                        FilterTypeConstants<span class="token punctuation">.</span>ExceptionFilter<span class="token punctuation">,</span>
                        <span class="token keyword">nameof</span><span class="token punctuation">(</span>IExceptionFilter<span class="token punctuation">.</span>OnException<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    filter<span class="token punctuation">.</span><span class="token function">OnException</span><span class="token punctuation">(</span>exceptionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    _diagnosticSource<span class="token punctuation">.</span><span class="token function">AfterOnException</span><span class="token punctuation">(</span>exceptionContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _logger<span class="token punctuation">.</span><span class="token function">AfterExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                        FilterTypeConstants<span class="token punctuation">.</span>ExceptionFilter<span class="token punctuation">,</span>
                        <span class="token keyword">nameof</span><span class="token punctuation">(</span>IExceptionFilter<span class="token punctuation">.</span>OnException<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>exceptionContext<span class="token punctuation">.</span>Exception <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> exceptionContext<span class="token punctuation">.</span>ExceptionHandled<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token comment">// We don't need to do anything to trigger a short circuit. If there's another</span>
                        <span class="token comment">// exception filter on the stack it will check the same set of conditions</span>
                        <span class="token comment">// and then just skip itself.</span>
                        _logger<span class="token punctuation">.</span><span class="token function">ExceptionFilterShortCircuited</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionInside<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionBegin<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionHandled<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// We arrive in this state when an exception happened, but was handled by exception filters</span>
                <span class="token comment">// either by setting ExceptionHandled, or nulling out the Exception or setting a result</span>
                <span class="token comment">// on the ExceptionContext.</span>
                <span class="token comment">//</span>
                <span class="token comment">// We need to execute the result (if any) and then exit gracefully which unwinding Resource</span>
                <span class="token comment">// filters.</span>

                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_exceptionContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>_exceptionContext<span class="token punctuation">.</span>Result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    _exceptionContext<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EmptyResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                _result <span class="token operator">=</span> _exceptionContext<span class="token punctuation">.</span>Result<span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">InvokeAlwaysRunResultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ResourceInsideEnd<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceInsideEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> exceptionContext <span class="token operator">=</span> _exceptionContext<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> Scope<span class="token punctuation">.</span>Exception<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    isCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>exceptionContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>exceptionContext<span class="token punctuation">.</span>Result <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
                        exceptionContext<span class="token punctuation">.</span>Exception <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
                        exceptionContext<span class="token punctuation">.</span>ExceptionHandled<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ExceptionHandled<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token function">Rethrow</span><span class="token punctuation">(</span>exceptionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Debug<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span><span class="token string">&quot;unreachable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">InvokeResultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ResourceInsideEnd<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceInsideEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">InvokeInnerFilterAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ActionEnd<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> Scope<span class="token punctuation">.</span>Exception<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// If we're inside an exception filter, let's allow those filters to 'unwind' before</span>
                    <span class="token comment">// the result.</span>
                    isCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>scope <span class="token operator">==</span> Scope<span class="token punctuation">.</span>Invoker <span class="token operator">||</span> scope <span class="token operator">==</span> Scope<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">InvokeResultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ResourceInsideEnd<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceInsideEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceInsideEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> Scope<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    _resourceExecutedContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ResourceExecutedContext</span><span class="token punctuation">(</span>_actionContext<span class="token punctuation">,</span> _filters<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        Result <span class="token operator">=</span> _result<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>

                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceEnd<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>InvokeEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ResourceEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> Scope<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    isCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>scope <span class="token operator">==</span> Scope<span class="token punctuation">.</span>Invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">Rethrow</span><span class="token punctuation">(</span>_resourceExecutedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>InvokeEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>InvokeEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                isCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从代码可以看出，它是根据状态State进行轮转，而执行顺序是Authorization-&gt;Resource-&gt;Exception......  也就是说当前action对应的多种类型的Filter会按照这样的顺序被执行，如下图</p> <p><img src="/blogimages/ASPNETCore2_17/548134-20190125113044773-1757917990.png" alt=""></p> <p>图四</p> <p>可以看出，在上面几个Filter执行之后，ActionFilter的执行比较特殊，它将Action的执行包在了中间，这段逻辑写在了ControllerActionInvoker自己的类中，同样是一个 <code>Task Next</code> 方法被while循环调用，如下</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token return-type class-name">Task</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">State</span> next<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name">Scope</span> scope<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name"><span class="token keyword">object</span></span> state<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name"><span class="token keyword">bool</span></span> isCompleted<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> controllerContext <span class="token operator">=</span> _controllerContext<span class="token punctuation">;</span>

                _cursor<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                _instance <span class="token operator">=</span> _cacheEntry<span class="token punctuation">.</span><span class="token function">ControllerFactory</span><span class="token punctuation">(</span>controllerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

                _arguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>StringComparer<span class="token punctuation">.</span>OrdinalIgnoreCase<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">BindArgumentsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ActionNext<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionNext<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionNext<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> current <span class="token operator">=</span> _cursor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetNextFilter</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IActionFilter<span class="token punctuation">,</span> IAsyncActionFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>FilterAsync <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_actionExecutingContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        _actionExecutingContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ActionExecutingContext</span><span class="token punctuation">(</span>_controllerContext<span class="token punctuation">,</span> _filters<span class="token punctuation">,</span> _arguments<span class="token punctuation">,</span> _instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    state <span class="token operator">=</span> current<span class="token punctuation">.</span>FilterAsync<span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionAsyncBegin<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>Filter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_actionExecutingContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        _actionExecutingContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ActionExecutingContext</span><span class="token punctuation">(</span>_controllerContext<span class="token punctuation">,</span> _filters<span class="token punctuation">,</span> _arguments<span class="token punctuation">,</span> _instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    state <span class="token operator">=</span> current<span class="token punctuation">.</span>Filter<span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionSyncBegin<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionInside<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionAsyncBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_actionExecutingContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IAsyncActionFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> actionExecutingContext <span class="token operator">=</span> _actionExecutingContext<span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">BeforeOnActionExecution</span><span class="token punctuation">(</span>actionExecutingContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">BeforeExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    MvcCoreLoggerExtensions<span class="token punctuation">.</span>ActionFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IAsyncActionFilter<span class="token punctuation">.</span>OnActionExecutionAsync<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">OnActionExecutionAsync</span><span class="token punctuation">(</span>actionExecutingContext<span class="token punctuation">,</span> InvokeNextActionFilterAwaitedAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ActionAsyncEnd<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionAsyncEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionAsyncEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_actionExecutingContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IAsyncActionFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>_actionExecutedContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// If we get here then the filter didn't call 'next' indicating a short circuit.</span>
                    _logger<span class="token punctuation">.</span><span class="token function">ActionFilterShortCircuited</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    _actionExecutedContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ActionExecutedContext</span><span class="token punctuation">(</span>
                        _controllerContext<span class="token punctuation">,</span>
                        _filters<span class="token punctuation">,</span>
                        _instance<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        Canceled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        Result <span class="token operator">=</span> _actionExecutingContext<span class="token punctuation">.</span>Result<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">AfterOnActionExecution</span><span class="token punctuation">(</span>_actionExecutedContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">AfterExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    MvcCoreLoggerExtensions<span class="token punctuation">.</span>ActionFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IAsyncActionFilter<span class="token punctuation">.</span>OnActionExecutionAsync<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionSyncBegin<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_actionExecutingContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IActionFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> actionExecutingContext <span class="token operator">=</span> _actionExecutingContext<span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">BeforeOnActionExecuting</span><span class="token punctuation">(</span>actionExecutingContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">BeforeExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    MvcCoreLoggerExtensions<span class="token punctuation">.</span>ActionFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IActionFilter<span class="token punctuation">.</span>OnActionExecuting<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                filter<span class="token punctuation">.</span><span class="token function">OnActionExecuting</span><span class="token punctuation">(</span>actionExecutingContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">AfterOnActionExecuting</span><span class="token punctuation">(</span>actionExecutingContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">AfterExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    MvcCoreLoggerExtensions<span class="token punctuation">.</span>ActionFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IActionFilter<span class="token punctuation">.</span>OnActionExecuting<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>actionExecutingContext<span class="token punctuation">.</span>Result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// Short-circuited by setting a result.</span>
                    _logger<span class="token punctuation">.</span><span class="token function">ActionFilterShortCircuited</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    _actionExecutedContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ActionExecutedContext</span><span class="token punctuation">(</span>
                        _actionExecutingContext<span class="token punctuation">,</span>
                        _filters<span class="token punctuation">,</span>
                        _instance<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        Canceled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        Result <span class="token operator">=</span> _actionExecutingContext<span class="token punctuation">.</span>Result<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>

                    <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionEnd<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">InvokeNextActionFilterAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ActionSyncEnd<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionSyncEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionSyncEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_actionExecutingContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>_actionExecutedContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token punctuation">(</span>IActionFilter<span class="token punctuation">)</span>state<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> actionExecutedContext <span class="token operator">=</span> _actionExecutedContext<span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">BeforeOnActionExecuted</span><span class="token punctuation">(</span>actionExecutedContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">BeforeExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    MvcCoreLoggerExtensions<span class="token punctuation">.</span>ActionFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IActionFilter<span class="token punctuation">.</span>OnActionExecuted<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                filter<span class="token punctuation">.</span><span class="token function">OnActionExecuted</span><span class="token punctuation">(</span>actionExecutedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

                _diagnosticSource<span class="token punctuation">.</span><span class="token function">AfterOnActionExecuted</span><span class="token punctuation">(</span>actionExecutedContext<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _logger<span class="token punctuation">.</span><span class="token function">AfterExecutingMethodOnFilter</span><span class="token punctuation">(</span>
                    MvcCoreLoggerExtensions<span class="token punctuation">.</span>ActionFilter<span class="token punctuation">,</span>
                    <span class="token keyword">nameof</span><span class="token punctuation">(</span>IActionFilter<span class="token punctuation">.</span>OnActionExecuted<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionInside<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">InvokeActionMethodAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>Status <span class="token operator">!=</span> TaskStatus<span class="token punctuation">.</span>RanToCompletion<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    next <span class="token operator">=</span> State<span class="token punctuation">.</span>ActionEnd<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">goto</span> <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionEnd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">case</span> State<span class="token punctuation">.</span>ActionEnd<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> Scope<span class="token punctuation">.</span>Action<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_actionExecutedContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        _actionExecutedContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ActionExecutedContext</span><span class="token punctuation">(</span>_controllerContext<span class="token punctuation">,</span> _filters<span class="token punctuation">,</span> _instance<span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            Result <span class="token operator">=</span> _result<span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    isCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name"><span class="token keyword">var</span></span> actionExecutedContext <span class="token operator">=</span> _actionExecutedContext<span class="token punctuation">;</span>
                <span class="token function">Rethrow</span><span class="token punctuation">(</span>actionExecutedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>actionExecutedContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    _result <span class="token operator">=</span> actionExecutedContext<span class="token punctuation">.</span>Result<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                isCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而在ActionBegin的时候，通过ControllerFactory创建了Controller并调用 <code>cacheEntry.ControllerBinderDelegate(_controllerContext, _instance, _arguments)</code> 进行了参数绑定。</p> <p>然后的顺序是   ActionFilter的OnActionExecuting方法 -&gt;action的执行-&gt;ActionFilter的OnActionExecuted方法， action的执行如下：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeActionMethodAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> controllerContext <span class="token operator">=</span> _controllerContext<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> objectMethodExecutor <span class="token operator">=</span> _cacheEntry<span class="token punctuation">.</span>ObjectMethodExecutor<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> controller <span class="token operator">=</span> _instance<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> arguments <span class="token operator">=</span> _arguments<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> actionMethodExecutor <span class="token operator">=</span> _cacheEntry<span class="token punctuation">.</span>ActionMethodExecutor<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> orderedArguments <span class="token operator">=</span> <span class="token function">PrepareArguments</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> objectMethodExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> diagnosticSource <span class="token operator">=</span> _diagnosticSource<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> logger <span class="token operator">=</span> _logger<span class="token punctuation">;</span>

    <span class="token class-name">IActionResult</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        diagnosticSource<span class="token punctuation">.</span><span class="token function">BeforeActionMethod</span><span class="token punctuation">(</span>
            controllerContext<span class="token punctuation">,</span>
            arguments<span class="token punctuation">,</span>
            controller<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">ActionMethodExecuting</span><span class="token punctuation">(</span>controllerContext<span class="token punctuation">,</span> orderedArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> stopwatch <span class="token operator">=</span> ValueStopwatch<span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> actionResultValueTask <span class="token operator">=</span> actionMethodExecutor<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>_mapper<span class="token punctuation">,</span> objectMethodExecutor<span class="token punctuation">,</span> controller<span class="token punctuation">,</span> orderedArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>actionResultValueTask<span class="token punctuation">.</span>IsCompletedSuccessfully<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            result <span class="token operator">=</span> actionResultValueTask<span class="token punctuation">.</span>Result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token keyword">await</span> actionResultValueTask<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        _result <span class="token operator">=</span> result<span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">ActionMethodExecuted</span><span class="token punctuation">(</span>controllerContext<span class="token punctuation">,</span> result<span class="token punctuation">,</span> stopwatch<span class="token punctuation">.</span><span class="token function">GetElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span>
    <span class="token punctuation">{</span>
        diagnosticSource<span class="token punctuation">.</span><span class="token function">AfterActionMethod</span><span class="token punctuation">(</span>
            controllerContext<span class="token punctuation">,</span>
            arguments<span class="token punctuation">,</span>
            controllerContext<span class="token punctuation">,</span>
            result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><span style="color:#ff6600;">总结： 如上文说的，本节的内容就是将准备阶段组装的多个方法在这里按一定的被逐步的执行（如图四）。</span></p> <p>大概内容就是这样，详细分析起来涉及细节还有好多，后面的文章会对一些关键内容进行详细分享。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dotnet/ASPNETCore2_16.html" class="prev">
        十六.新的Endpoint路由方案
      </a></span> <span class="next"><a href="/dotnet/ASPNETCore2_18.html">
        十八.Filter的处理机制及执行顺序
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5c4124d9.js" defer></script><script src="/assets/js/2.5052fd89.js" defer></script><script src="/assets/js/58.508c5ac0.js" defer></script>
  </body>
</html>
