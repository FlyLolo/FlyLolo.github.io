<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>五.服务的加载与运行 | FlyLolo 闲聊编程</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="没事敲敲代码">
    
    <link rel="preload" href="/assets/css/0.styles.b23bcaa9.css" as="style"><link rel="preload" href="/assets/js/app.5c4124d9.js" as="script"><link rel="preload" href="/assets/js/2.5052fd89.js" as="script"><link rel="preload" href="/assets/js/68.2f1ad103.js" as="script"><link rel="prefetch" href="/assets/js/10.ebd354ff.js"><link rel="prefetch" href="/assets/js/11.c0ba7b39.js"><link rel="prefetch" href="/assets/js/12.d2df4345.js"><link rel="prefetch" href="/assets/js/13.ad189de6.js"><link rel="prefetch" href="/assets/js/14.211e1c27.js"><link rel="prefetch" href="/assets/js/15.bc9f8b57.js"><link rel="prefetch" href="/assets/js/16.5cc9b653.js"><link rel="prefetch" href="/assets/js/17.4281fea3.js"><link rel="prefetch" href="/assets/js/18.1c3b6824.js"><link rel="prefetch" href="/assets/js/19.19526aaa.js"><link rel="prefetch" href="/assets/js/20.55520ac3.js"><link rel="prefetch" href="/assets/js/21.68aa2210.js"><link rel="prefetch" href="/assets/js/22.976b6f6a.js"><link rel="prefetch" href="/assets/js/23.9241ad9a.js"><link rel="prefetch" href="/assets/js/24.87e81add.js"><link rel="prefetch" href="/assets/js/25.5a324370.js"><link rel="prefetch" href="/assets/js/26.6e0c7b3a.js"><link rel="prefetch" href="/assets/js/27.c2db3589.js"><link rel="prefetch" href="/assets/js/28.f504554f.js"><link rel="prefetch" href="/assets/js/29.0b8cbb3f.js"><link rel="prefetch" href="/assets/js/3.dc0bd479.js"><link rel="prefetch" href="/assets/js/30.18cf6f70.js"><link rel="prefetch" href="/assets/js/31.90a5f0a4.js"><link rel="prefetch" href="/assets/js/32.454348da.js"><link rel="prefetch" href="/assets/js/33.1c21d0c1.js"><link rel="prefetch" href="/assets/js/34.a2fc1109.js"><link rel="prefetch" href="/assets/js/35.7123c8b5.js"><link rel="prefetch" href="/assets/js/36.6a74523e.js"><link rel="prefetch" href="/assets/js/37.4a0d5e49.js"><link rel="prefetch" href="/assets/js/38.870830b5.js"><link rel="prefetch" href="/assets/js/39.7a99876d.js"><link rel="prefetch" href="/assets/js/4.2543b7ad.js"><link rel="prefetch" href="/assets/js/40.1ab956e2.js"><link rel="prefetch" href="/assets/js/41.e2cd491a.js"><link rel="prefetch" href="/assets/js/42.8118b296.js"><link rel="prefetch" href="/assets/js/43.3b58128f.js"><link rel="prefetch" href="/assets/js/44.1648ce27.js"><link rel="prefetch" href="/assets/js/45.0e2feba0.js"><link rel="prefetch" href="/assets/js/46.8cacc6f0.js"><link rel="prefetch" href="/assets/js/47.85a42084.js"><link rel="prefetch" href="/assets/js/48.887f0baf.js"><link rel="prefetch" href="/assets/js/49.311ea494.js"><link rel="prefetch" href="/assets/js/5.82bf0454.js"><link rel="prefetch" href="/assets/js/50.1a3416b2.js"><link rel="prefetch" href="/assets/js/51.17ac5138.js"><link rel="prefetch" href="/assets/js/52.0e0119e0.js"><link rel="prefetch" href="/assets/js/53.a74775a2.js"><link rel="prefetch" href="/assets/js/54.4dc1f4cf.js"><link rel="prefetch" href="/assets/js/55.782ceae6.js"><link rel="prefetch" href="/assets/js/56.d371faac.js"><link rel="prefetch" href="/assets/js/57.42acf1f9.js"><link rel="prefetch" href="/assets/js/58.508c5ac0.js"><link rel="prefetch" href="/assets/js/59.a747c5df.js"><link rel="prefetch" href="/assets/js/6.d83b86ff.js"><link rel="prefetch" href="/assets/js/60.1a0f169d.js"><link rel="prefetch" href="/assets/js/61.eb35190d.js"><link rel="prefetch" href="/assets/js/62.508f7c4c.js"><link rel="prefetch" href="/assets/js/63.4c9bbdbe.js"><link rel="prefetch" href="/assets/js/64.5f784752.js"><link rel="prefetch" href="/assets/js/65.83e85dd4.js"><link rel="prefetch" href="/assets/js/66.c3c68bbd.js"><link rel="prefetch" href="/assets/js/67.15ce6b9a.js"><link rel="prefetch" href="/assets/js/69.e220c066.js"><link rel="prefetch" href="/assets/js/7.fbd6423b.js"><link rel="prefetch" href="/assets/js/70.024cc331.js"><link rel="prefetch" href="/assets/js/71.424df8a7.js"><link rel="prefetch" href="/assets/js/72.87abc657.js"><link rel="prefetch" href="/assets/js/73.ea6962e5.js"><link rel="prefetch" href="/assets/js/74.c50c111e.js"><link rel="prefetch" href="/assets/js/75.4d2a7dbe.js"><link rel="prefetch" href="/assets/js/76.49e30c54.js"><link rel="prefetch" href="/assets/js/77.5d8c8f6d.js"><link rel="prefetch" href="/assets/js/78.5b4f8e29.js"><link rel="prefetch" href="/assets/js/79.316dc7d8.js"><link rel="prefetch" href="/assets/js/8.a45bb22d.js"><link rel="prefetch" href="/assets/js/80.b1c365a1.js"><link rel="prefetch" href="/assets/js/81.cb25e543.js"><link rel="prefetch" href="/assets/js/82.7bc18643.js"><link rel="prefetch" href="/assets/js/83.6c0ee3d0.js"><link rel="prefetch" href="/assets/js/84.f8184dc3.js"><link rel="prefetch" href="/assets/js/85.b0a7f43e.js"><link rel="prefetch" href="/assets/js/86.af5fcb58.js"><link rel="prefetch" href="/assets/js/9.55a96ecc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b23bcaa9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="FlyLolo 闲聊编程" class="logo"> <span class="site-name can-hide">FlyLolo 闲聊编程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/dotnet/" class="nav-link router-link-active">
  .NET
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  DB
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/dotnet/" class="nav-link router-link-active">
  .NET
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  DB
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ASP.NET Core</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dotnet/" aria-current="page" class="sidebar-link">新书上市</a></li><li><a href="/dotnet/ASPNETCore2_1.html" class="sidebar-link">一. 概述</a></li><li><a href="/dotnet/ASPNETCore2_2.html" class="sidebar-link">二. 开发环境</a></li><li><a href="/dotnet/ASPNETCore2_3.html" class="sidebar-link">三. 项目结构</a></li><li><a href="/dotnet/ASPNETCore2_4.html" class="sidebar-link">四. Layout与ViewStart</a></li><li><a href="/dotnet/ASPNETCore2_5.html" aria-current="page" class="active sidebar-link">五.服务的加载与运行</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/ASPNETCore2_5.html#_1-asp-net-core-的运行机制" class="sidebar-link">1. ASP.NET Core 的运行机制</a></li><li class="sidebar-sub-header"><a href="/dotnet/ASPNETCore2_5.html#_2-asp-net-core-的启动" class="sidebar-link">2. ASP.NET Core 的启动</a></li><li class="sidebar-sub-header"><a href="/dotnet/ASPNETCore2_5.html#_3-webhostbuilder的一系列配置" class="sidebar-link">3. WebHostBuilder的一系列配置</a></li><li class="sidebar-sub-header"><a href="/dotnet/ASPNETCore2_5.html#_4-asp-net-core-的环境" class="sidebar-link">4. ASP.NET Core 的环境</a></li><li class="sidebar-sub-header"><a href="/dotnet/ASPNETCore2_5.html#_5-小结" class="sidebar-link">5. 小结</a></li></ul></li><li><a href="/dotnet/ASPNETCore2_6.html" class="sidebar-link">六. 聊聊依赖注入</a></li><li><a href="/dotnet/ASPNETCore2_7.html" class="sidebar-link">七.启动背后的秘密</a></li><li><a href="/dotnet/ASPNETCore2_8.html" class="sidebar-link">八.图说管道</a></li><li><a href="/dotnet/ASPNETCore2_9.html" class="sidebar-link">九.发布到CentOS</a></li><li><a href="/dotnet/ASPNETCore2_10.html" class="sidebar-link">十.升级到2.1</a></li><li><a href="/dotnet/ASPNETCore2_11.html" class="sidebar-link">十一.运行后台任务</a></li><li><a href="/dotnet/ASPNETCore2_12.html" class="sidebar-link">十二.内置日志与Nlog</a></li><li><a href="/dotnet/ASPNETCore2_13.html" class="sidebar-link">十三.httpClient.GetAsync 报SSL错误</a></li><li><a href="/dotnet/ASPNETCore2_14.html" class="sidebar-link">十四.静态文件访问与授权</a></li><li><a href="/dotnet/ASPNETCore2_15.html" class="sidebar-link">十五.图解路由(2.1 or earler)</a></li><li><a href="/dotnet/ASPNETCore2_16.html" class="sidebar-link">十六.新的Endpoint路由方案</a></li><li><a href="/dotnet/ASPNETCore2_17.html" class="sidebar-link">十七.Action的执行</a></li><li><a href="/dotnet/ASPNETCore2_18.html" class="sidebar-link">十八.Filter的处理机制及执行顺序</a></li><li><a href="/dotnet/ASPNETCore2_19.html" class="sidebar-link">十九. Action参数的映射与模型绑定</a></li><li><a href="/dotnet/ASPNETCore2_20.html" class="sidebar-link">二十.Action的数据返回格式处理</a></li><li><a href="/dotnet/ASPNETCore2_21.html" class="sidebar-link">二十一. 内容协商与自定义返回格式</a></li><li><a href="/dotnet/ASPNETCore_22.html" class="sidebar-link">二十二. 多样性的配置方式</a></li><li><a href="/dotnet/ASPNETCore_23.html" class="sidebar-link">二十三. 配置的内部处理机制</a></li><li><a href="/dotnet/ASPNETCore_24.html" class="sidebar-link">二十四. Options模式的配置</a></li><li><a href="/dotnet/ASPNETCore_25.html" class="sidebar-link">二十五. TagHelper</a></li><li><a href="/dotnet/ASPNETCore2_26.html" class="sidebar-link">二十六. 应用JWT进行用户认证</a></li><li><a href="/dotnet/ASPNETCore2_27.html" class="sidebar-link">二十七. JWT与用户授权</a></li><li><a href="/dotnet/ASPNETCore_28.html" class="sidebar-link">二十八. 在Docker中部署</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>C# 其他</span> <!----></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="五-服务的加载与运行"><a href="#五-服务的加载与运行" class="header-anchor">#</a> 五.服务的加载与运行</h1> <hr> <p>&quot;跨平台&quot;后的ASP.Net Core是如何接收并处理请求的呢? 它的运行和处理机制和之前有什么不同?</p> <p>本章从&quot;宏观&quot;到&quot;微观&quot;地看一下它的结构以及不同时期都干了些什么.</p> <p><a href="http://www.cnblogs.com/FlyLolo/p/ASPNETCore2_0.html" target="_blank" rel="noopener noreferrer"><span data-ttu-id="4542a-111">ASP.NET Core 系列目录</span><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>本章主要内容如下:</strong></p> <p>ASP.NET Core 的运行机制: &quot;宏观&quot;的看一下Http请求的处理流程.</p> <p>ASP.NET Core 的配置与运行: 2倍放大后的ASP.NET Core Application, Kestrel服务器、启动与配置</p> <p>ASP.NET Core 的环境变量.</p> <h2 id="_1-asp-net-core-的运行机制"><a href="#_1-asp-net-core-的运行机制" class="header-anchor">#</a> 1. ASP.NET Core 的运行机制</h2> <p><img src="/blogimages/ASPNETCore2_5/548134-20180220195943455-548897477.jpg" alt=""></p> <p>图1</p> <p>ASP.NET Core 的运行机制如上图所示, 现在做一下详细说明.</p> <p>ASP.NET Core提供两种服务器可用, 分别是Kestrel和HTTP.sys(Core 1.x 中被命名为 WebListener),</p> <p>A. Kestrel是一个跨平台的Web服务器;</p> <p>B. HTTP.sys只能用在Windows系统中.</p> <p>②Internet:当需要部署在Internal Network 中并需要 Kestrel 中没有的功能（如 Windows 身份验证）时，可以选择HTTP.sys。</p> <p>③IIS、Apache、Nginx: Kestrel 可以单独使用 ，也可以将其与反向代理服务器（如 IIS、Nginx 或 Apache）结合使用。 请求经这些服务器进行初步处理后转发给Kestrel(即图中虚线的可选流程).</p> <p>大概的运行机制就是这样, 那么具体到ASP.NET Core Application是如何运行的呢? 我们将图1中ASP.NET Core Application这个红框框放大一下,看下一节.</p> <h2 id="_2-asp-net-core-的启动"><a href="#_2-asp-net-core-的启动" class="header-anchor">#</a> 2. ASP.NET Core 的启动</h2> <p>看一下将图1的ASP.NET Core Application放大后的样子:</p> <p><img src="/blogimages/ASPNETCore2_5/548134-20180227224819998-776243394.png" alt=""></p> <p>图2</p> <p>④Main方法, 程序的起点.</p> <p>⑤创建并配置WebHostBuilder: 首先调用Create­DefaultBuilder( 如图所示, 它是一系列配置的大综合,下文做详细介绍), 进行一系列配置之后, 调用<code>UseStartup&lt;T&gt;()</code>,</p> <p>指定为启动配置文件. 在Startup中, 将进行两个比较重要的工作, ⑧服务的依赖注入⑨配置管道, 后文将对这一部分详细的介绍.</p> <p>⑥生成WebHostBuilder并进行了一系列配置之后, 通过这个WebHostBuilder来Build出一个IWebHost.</p> <p>⑦调用IWebHost的Run方法使之开始运行.</p> <p>ASP.NET Core 应用程序本质上是控制台应用程序，所以它也是以一个我们熟悉的Main方法作为程序的起点.</p> <p>打开Program.cs文件, 默认是如下代码</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">BuildWebHost</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IWebHost</span> <span class="token function">BuildWebHost</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            WebHost<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseStartup</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Startup<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>定义了一个BuildWebHost方法, 在Main中调用它返回一个IWebHost, 并使这个IWebHost&quot;Run起来&quot;. 再看BuildWebHost方法内部, 通过调用CreateDefaultBuilder</p> <p>创建了一个IWebHostBuilder, 然后用这个Builder来Build出一个IWebHost.</p> <p>简单来说就是 创建<code>IWebHostBuilder=&gt;Builder=&gt;Build()=&gt;IWebHost=&gt;Run()</code>.</p> <h2 id="_3-webhostbuilder的一系列配置"><a href="#_3-webhostbuilder的一系列配置" class="header-anchor">#</a> 3. WebHostBuilder的一系列配置</h2> <p>系统离不开各种各样的配置, 比如常见的读取配置文件, 指定日志处理程序等, 我们详细的看一下.</p> <h3 id="create­defaultbuilder"><a href="#create­defaultbuilder" class="header-anchor">#</a> Create­DefaultBuilder</h3> <p>CreateDefaultBuilder, 顾名思义, 它是一个默认配置 . 如图2所示, 它主要是调用了各种ConfigureXXX和UseXXX, 首先看一下它的源码</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token number">1</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IWebHostBuilder</span> <span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{</span>
<span class="token number">3</span>     <span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebHostBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">4</span>         <span class="token punctuation">.</span><span class="token function">UseKestrel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">5</span>         <span class="token punctuation">.</span><span class="token function">UseContentRoot</span><span class="token punctuation">(</span>Directory<span class="token punctuation">.</span><span class="token function">GetCurrentDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">6</span>         <span class="token punctuation">.</span><span class="token function">ConfigureAppConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">(</span>hostingContext<span class="token punctuation">,</span> config<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token number">7</span>         <span class="token punctuation">{</span>
<span class="token number">8</span>             <span class="token class-name"><span class="token keyword">var</span></span> env <span class="token operator">=</span> hostingContext<span class="token punctuation">.</span>HostingEnvironment<span class="token punctuation">;</span>
<span class="token number">9</span> 
<span class="token number">10</span>             config<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">&quot;appsettings.json&quot;</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">optional</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">reloadOnChange</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token number">11</span>                   <span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;appsettings.</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">env<span class="token punctuation">.</span>EnvironmentName</span><span class="token punctuation">}</span></span><span class="token string">.json&quot;</span></span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">optional</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">reloadOnChange</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">12</span> 
<span class="token number">13</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">14</span>             <span class="token punctuation">{</span>
<span class="token number">15</span>                 <span class="token class-name"><span class="token keyword">var</span></span> appAssembly <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AssemblyName</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>ApplicationName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">16</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span>appAssembly <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token number">17</span>                 <span class="token punctuation">{</span>
<span class="token number">18</span>                     config<span class="token punctuation">.</span><span class="token function">AddUserSecrets</span><span class="token punctuation">(</span>appAssembly<span class="token punctuation">,</span> <span class="token named-parameter punctuation">optional</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">19</span>                 <span class="token punctuation">}</span>
<span class="token number">20</span>             <span class="token punctuation">}</span>
<span class="token number">21</span> 
<span class="token number">22</span>             config<span class="token punctuation">.</span><span class="token function">AddEnvironmentVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">23</span> 
<span class="token number">24</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token number">25</span>             <span class="token punctuation">{</span>
<span class="token number">26</span>                 config<span class="token punctuation">.</span><span class="token function">AddCommandLine</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">27</span>             <span class="token punctuation">}</span>
<span class="token number">28</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token number">29</span>         <span class="token punctuation">.</span><span class="token function">ConfigureLogging</span><span class="token punctuation">(</span><span class="token punctuation">(</span>hostingContext<span class="token punctuation">,</span> logging<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token number">30</span>         <span class="token punctuation">{</span>
<span class="token number">31</span>             logging<span class="token punctuation">.</span><span class="token function">AddConfiguration</span><span class="token punctuation">(</span>hostingContext<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">&quot;Logging&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">32</span>             logging<span class="token punctuation">.</span><span class="token function">AddConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">33</span>             logging<span class="token punctuation">.</span><span class="token function">AddDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">34</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token number">35</span>         <span class="token punctuation">.</span><span class="token function">UseIISIntegration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">36</span>         <span class="token punctuation">.</span><span class="token function">UseDefaultServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token number">37</span>         <span class="token punctuation">{</span>
<span class="token number">38</span>             options<span class="token punctuation">.</span>ValidateScopes <span class="token operator">=</span> context<span class="token punctuation">.</span>HostingEnvironment<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">39</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">40</span> 
<span class="token number">41</span>     <span class="token keyword">return</span> builder<span class="token punctuation">;</span>
<span class="token number">42</span> <span class="token punctuation">}</span>
</code></pre></div><p>上面的源码中我们看到它这些ConfigureXXX和UseXXX的过程, 而在Core 1.0版本中是没有CreateDefaultBuilder这个方法的,</p> <p>系统默认是逐个调用这些ConfigureXXX和UseXXX的,在Core 2.0中, 为了代码简洁和使用方便, 将这些常规情况下需要调用的方法放到了这个名为CreateDefaultBuilder的方法中.</p> <p>一般情况下，调用Create­DefaultBuilder 执行其中的这些的默认配置足够用了。但既然这是默认配置,  我们就可以根据自身情况自定义.</p> <p>因为这些配置都是对 WebHostBuilder进行修改, 而修改后再次返回修改后的 WebHostBuilder, 所以在Create­DefaultBuilder不符合现实需求的情况下可以通过如下的方法进行自定义.</p> <p>1)不调用Create­DefaultBuilder, 将上面讲到的这些配置选择性的执行, 甚至可以添加、替换里面的某些配置, 如将UseKestrel改为UseHttpSys.</p> <p>2)小幅改动, 即调用Create­DefaultBuilder之后再对其返回的WebHostBuilder调用自定义的其他配置方法. 例如可以再次调用 ConfigureAppConfiguration，从而添加更多的配置源.</p> <p>下面来介绍一下这些ConfigureXXX和UseXXX.</p> <h3 id="a-usekestrel"><a href="#a-usekestrel" class="header-anchor">#</a> A. UseKestrel</h3> <p>用于指定服务器使用 Kestrel, 若使用HttpSys, 需使用UseHttpSys。</p> <p><span data-ttu-id="24e91-105">Kestrel 是跨平台 ASP.NET Core Web 服务器，它基于 libuv（一个跨平台异步 I/O 库）。 <span data-ttu-id="24e91-106">Kestrel 是 Web 服务器，默认包括在 ASP.NET Core 项目模板中。 </span></span></p> <p><span data-ttu-id="24e91-107">Kestrel 支持以下功能：</span></p> <ul><li><p><span data-ttu-id="24e91-108">HTTPS</span></p></li> <li><p><span data-ttu-id="24e91-109">用于启用 WebSocket 的不透明升级</span></p></li> <li><p><span data-ttu-id="24e91-110">用于获得 Nginx 高性能的 Unix 套接字.</span></p></li></ul> <p><span data-ttu-id="24e91-110"><span data-ttu-id="24e91-145">默认情况下，ASP.NET Core 项目模板使用的是 Kestrel。</span></span></p> <p><span data-ttu-id="24e91-110"><span data-ttu-id="24e91-145">我们可以再次调用UseKestrel来修改Kestrel的配置, 例如限制请求正文的最大值</span></span></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IWebHost</span> <span class="token function">BuildWebHost</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        WebHost<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseStartup</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Startup<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UseKestrel</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span>Limits<span class="token punctuation">.</span>MaxRequestBodySize <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="b-usecontentroot"><a href="#b-usecontentroot" class="header-anchor">#</a> B. UseContentRoot</h3> <p>为应用程序指定根目录。需注意这和 StaticFiles的根<span style="font-family:Menlo;">是不同的, 虽然</span>默认情况下StaticFiles的根是以ContentRoot为依据 ([ContentRoot]/wwwroot)。</p> <h3 id="c-configureappconfiguration"><a href="#c-configureappconfiguration" class="header-anchor">#</a> C. ConfigureAppConfiguration</h3> <p>读取配置。如上代码会读取 <code>appsettings.json</code> 和 <code>appsettings.{env.EnvironmentName}.json</code> , env.EnvironmentName指的是环境, 例如Development. 当在Development环境的时候, 还会读取<span style="font-family:'PingFang SC', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;">用户密钥。</span></p> <p><span style="font-family:'PingFang SC', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;">这部分在学习系统配置的时候详细介绍.</span></p> <h3 id="d-configurelogging"><a href="#d-configurelogging" class="header-anchor">#</a> D. ConfigureLogging</h3> <p>配置日志处理程序,控制台和调试日志提供程序, 学习日志的时候再详讲.</p> <h3 id="e-useiisintegration"><a href="#e-useiisintegration" class="header-anchor">#</a> E. UseIISIntegration</h3> <p>将应用程序配置为在 IIS 中运行。上面已经讲过, 这里仍需要使用 UseKestrel, 而IIS 起到反向代理的作用，而 Kestrel 仍用作主机。</p> <p>如果应用程序没有使用 IIS 作为反向代理，那么 UseIISIntegration 不会有任何效果。因此，即使应用程序在非 IIS 方案中运行，也可以安全调用这种方法。</p> <h3 id="f-usedefaultserviceprovider"><a href="#f-usedefaultserviceprovider" class="header-anchor">#</a> F.UseDefaultServiceProvider</h3> <p>设置默认的依赖注入容器, 这部分在后面学习依赖注入的时候再详讲.</p> <h2 id="_4-asp-net-core-的环境"><a href="#_4-asp-net-core-的环境" class="header-anchor">#</a> 4. ASP.NET Core 的环境</h2> <p>在 ASP.NET Core 中，有个非常重要而且常用的东西叫环境变量, 它由 ASPNETCORE_ENVIRONMENT 环境变量指定。</p> <p>我们可以根据需要将此变量设置为任意值，但通常使用的是值 Development、Staging 和 Production。它定义了当前应用程序的运行环境, 我们经常会根据这个变量来让应用采用不同的处理方式.</p> <p>在上面的例子中, 就有这样的用法</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
         <span class="token class-name"><span class="token keyword">var</span></span> appAssembly <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AssemblyName</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>ApplicationName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>appAssembly <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
         <span class="token punctuation">{</span>
              config<span class="token punctuation">.</span><span class="token function">AddUserSecrets</span><span class="token punctuation">(</span>appAssembly<span class="token punctuation">,</span> <span class="token named-parameter punctuation">optional</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>_Layout  View  中</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token operator">&lt;</span><span class="token class-name">environment</span> include<span class="token operator">=</span><span class="token string">&quot;Development&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token class-name">link</span> rel<span class="token operator">=</span><span class="token string">&quot;stylesheet&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;~/lib/bootstrap/dist/css/bootstrap.css&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token class-name">link</span> rel<span class="token operator">=</span><span class="token string">&quot;stylesheet&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;~/css/site.css&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>environment<span class="token operator">&gt;</span>
</code></pre></div><p>因此，如果在run 之前将 ASPNETCORE_ENVIRONMENT 变量设置为 Development（或在 launchSettings.json 文件中设置此环境变量），</p> <p>应用程序会在 Development 模式下运行，而不是 Production 模式（这是不设置任何变量时的默认模式）。</p> <p><span data-ttu-id="0627d-115">注意：在 Windows 和 macOS 上，环境变量和值不区分大小写。<span class="sxs-lookup"><span data-stu-id="0627d-115"><span data-ttu-id="0627d-116">Linux 环境变量和值区分大小写。</span></span></span></span></p> <h2 id="_5-小结"><a href="#_5-小结" class="header-anchor">#</a> 5. 小结</h2> <p>通过上面的内容大概对ASP.NET Core 2.0 的服务启动、配置与运行, 运行环境等做了大概的了解, 其中涉及的部分内容如读取配置、日志等, 将在后期单独介绍.</p> <p>除了上述内容, ASP.NET Core留给我们作为扩展的地方主要放在了Startup文件中, 即图2中的<span style="color:#ff6600;">⑩Startup, </span>这里进行了两个比较重要的工作, <span style="color:#ff6600;">⑧服务的依赖注入</span>和<span style="color:#ff6600;">⑨配置管道</span>,</p> <p>下文我们将图2的<span style="color:#ff6600;">⑩Startu</span><span style="color:#ff6600;">p这个红框框放大一些, 看看这里都做了些什么.</span></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dotnet/ASPNETCore2_4.html" class="prev">
        四. Layout与ViewStart
      </a></span> <span class="next"><a href="/dotnet/ASPNETCore2_6.html">
        六. 聊聊依赖注入
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5c4124d9.js" defer></script><script src="/assets/js/2.5052fd89.js" defer></script><script src="/assets/js/68.2f1ad103.js" defer></script>
  </body>
</html>
