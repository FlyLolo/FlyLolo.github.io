(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{313:function(t,s,a){"use strict";function n(t,s,a,n,e,r,p,o){var c,v="function"==typeof t?t.options:t;if(s&&(v.render=s,v.staticRenderFns=a,v._compiled=!0),n&&(v.functional=!0),r&&(v._scopeId="data-v-"+r),p?(c=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),e&&e.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(p)},v._ssrRegister=c):e&&(c=o?function(){e.call(this,(v.functional?this.parent:this).$root.$options.shadowRoot)}:e),c)if(v.functional){v._injectStyles=c;var _=v.render;v.render=function(t,s){return c.call(s),_(t,s)}}else{var i=v.beforeCreate;v.beforeCreate=i?[].concat(i,c):[c]}return{exports:t,options:v}}a.d(s,"a",(function(){return n}))},434:function(t,s,a){"use strict";a.r(s);var n=a(313),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"七-启动背后的秘密"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#七-启动背后的秘密"}},[t._v("#")]),t._v(" 七.启动背后的秘密")]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("为什么我们可以在Startup这个 “孤零零的” 类中配置依赖注入和管道？")]),t._v(" "),a("p",[t._v("它是什么时候被实例化并且调用的？")]),t._v(" "),a("p",[t._v("参数中的IServiceCollection services是怎么来的?")]),t._v(" "),a("p",[t._v("处理管道是怎么构建起来的？")]),t._v(" "),a("p",[t._v("启动过程中，系统“默默的”做了哪些准备工作？")]),t._v(" "),a("p",[t._v("上一篇文章讲了ASP.NET Core中的依赖注入， 而它的配置是在Startup这个文件中的 "),a("code",[t._v("ConfigureServices(IServiceCollection services)")]),t._v(" 方法，而且Startup这个类也没有继承任何类或者接口。 深入的想一想，可能会冒出类似上面列出的好多问题，下面用一幅图来看透它。")]),t._v(" "),a("h2",{attrs:{id:"_1-整体流程图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-整体流程图"}},[t._v("#")]),t._v(" 1. 整体流程图")]),t._v(" "),a("p",[t._v("先上图， 觉得看不清可以点击看大图或者下载后放大查看。")]),t._v(" "),a("p",[a("a",{attrs:{href:"/blogimages/ASPNETCore2_7/548134-20180321160719074-1992689731.png"}},[a("img",{attrs:{src:"/blogimages/ASPNETCore2_7/548134-20180321160719074-1992689731.png",alt:""}})])]),t._v(" "),a("p",[t._v("图一  （"),a("a",{attrs:{href:"/blogimages/ASPNETCore2_7/548134-20180321160719074-1992689731.png"}},[t._v("点击放大")]),t._v("）")]),t._v(" "),a("h2",{attrs:{id:"_2-webhostbuilder"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-webhostbuilder"}},[t._v("#")]),t._v(" 2. WebHostBuilder")]),t._v(" "),a("p",[t._v("应用程序在Main方法之后通过调用Create­DefaultBuilder方法创建并配置WebHostBuilder，")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebHostBuilder")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IWebHostBuilder\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("readonly")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Action"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("WebHostBuilderContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IServiceCollection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" _configureServicesDelegates"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" \n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IConfiguration")]),t._v(" _config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[t._v("IWebHostBuilder")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("UseSetting")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("string")])]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("string")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("             _config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v("             "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[t._v("IWebHostBuilder")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ConfigureServices")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Action"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("WebHostBuilderContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IServiceCollection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" configureServices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v("             "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("configureServices "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),t._v("             "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),t._v("                 "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[t._v("ArgumentNullException")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("nameof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("configureServices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("27")]),t._v("             "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("29")]),t._v("             _configureServicesDelegates"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("configureServices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v("             "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("31")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("WebHostBuilder存在一个重要的集合"),a("span",{staticStyle:{color:"#ff6600"}},[t._v("①")]),t._v(" "),a("code",[t._v('<span style="color: #0000ff;">private')]),t._v(" "),a("span",{staticStyle:{color:"#0000ff"}},[t._v("readonly")]),t._v(" List<Action<WebHostBuilderContext, IServiceCollection>> _configureServicesDelegates;"),t._v(" ， 通过 "),a("code",[t._v("ConfigureServices")]),t._v(" 方法将需要的Action加入进来。")]),t._v(" "),a("p",[t._v("UseSetting是一个用于设置Key-Value的方法， 一些常用的配置均会通过此方法写入_config中。")]),t._v(" "),a("h2",{attrs:{id:"_3-usestartup-startup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-usestartup-startup"}},[t._v("#")]),t._v(" 3. "),a("code",[t._v("UseStartup<Startup>()")])]),t._v(" "),a("p",[t._v("Create­DefaultBuilder之后调用"),a("code",[t._v("UseStartup<Startup>()")]),t._v("，指定Startup为启动类。")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[t._v("IWebHostBuilder")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("UseStartup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IWebHostBuilder")]),t._v(" hostBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Type")]),t._v(" startupType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")])]),t._v(" startupAssemblyName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" startupType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetTypeInfo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Assembly"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" hostBuilder\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("UseSetting")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("WebHostDefaults"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ApplicationKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" startupAssemblyName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ConfigureServices")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("services "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token type-expression class-name"}},[t._v("IStartup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetTypeInfo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsAssignableFrom")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("startupType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetTypeInfo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                services"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddSingleton")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token type-expression class-name"}},[t._v("IStartup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" startupType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                services"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddSingleton")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token type-expression class-name"}},[t._v("IStartup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")])]),t._v(" hostingEnvironment "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetRequiredService")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("IHostingEnvironment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[t._v("ConventionBasedStartup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("StartupLoader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LoadMethods")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" startupType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hostingEnvironment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EnvironmentName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("首先获取Startup类对应的AssemblyName， 调用UseSetting方法将其设置为WebHostDefaults.ApplicationKey（“applicationName”）的值。")]),t._v(" "),a("p",[t._v("然后调用WebHostBuilder的"),a("span",{staticStyle:{color:"#ff6600"}},[t._v("②")]),a("span",{staticStyle:{color:"#ff6600"}},[t._v("ConfigureServices")]),t._v("方法，将一个Action写入WebHostBuilder 的 configureServicesDelegates中。")]),t._v(" "),a("p",[t._v("这个Action的意思就是说，如果这个被指定的类startupType是一个实现了IStartup的类， 那么将其通过AddSingleton注册到services 这个ServiceCollection中， 如果不是， 那么将其“转换”成 ConventionBasedStartup 这个实现了 IStartup的类后再进行注册。这里涉及到一个StartupLoader的LoadMethods()方法，会通过字符串的方式查找“ConfigureServices”、“Configure{"),a("span",{staticStyle:{"font-family":"Menlo"}},[t._v(" environmentName")]),t._v("}Services”这样的方法。")]),t._v(" "),a("p",[a("span",{staticStyle:{color:"#ff6600"}},[t._v("注意：这里只是将一个Action写入了configureServicesDelegates， 而不是已经执行了对IStartup的注册， 因为这个Action尚未执行，services也还不存在。"),a("span",{staticStyle:{color:"#000000"}},[t._v("就像菩萨对八戒说： 八戒（Startup）你先在高老庄等着吧， 将来有个和尚带领一个取经小分队（ServiceCollection "),a("span",{attrs:{"data-mce-":""}},[t._v("services ")]),t._v("）过来的时候你加入他们。")])])]),t._v(" "),a("p",[a("span",{staticStyle:{color:"#ff6600"}},[a("span",{staticStyle:{color:"#000000"}},[t._v("其实在Create­DefaultBuilder方法中的几个UseXXX的方法也是这样通过ConfigureServices将对应的Action写入了configureServicesDelegates， 等待唐僧的到来。")])])]),t._v(" "),a("h2",{attrs:{id:"_4-webhostbuilder-build"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-webhostbuilder-build"}},[t._v("#")]),t._v(" 4. WebHostBuilder.Build()")]),t._v(" "),a("p",[a("span",{staticStyle:{color:"#ff6600"}},[a("span",{staticStyle:{color:"#000000"}},[t._v("创建并配置好的WebHostBuilder开始通过Build方法创建WebHost了， 首先是BuildCommonServices， ")])])]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[t._v("IServiceCollection")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BuildCommonServices")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("out")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AggregateException")]),t._v(" hostingStartupErrors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//...省略...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")])]),t._v(" services "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[t._v("ServiceCollection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("     services"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddSingleton")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("_hostingEnvironment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v("     services"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddSingleton")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("_context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//....各种Add....")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("foreach")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")])]),t._v(" configureServices "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" _configureServicesDelegates"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("configureServices")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("_context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" services"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" services"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("span",{attrs:{"data-mce-":""}},[a("span",{attrs:{"data-mce-":""}},[t._v(" 在这个方法里创建了ServiceCollection "),a("span",{attrs:{"data-mce-":""}},[t._v("services（以唐僧为首的取经小分队）， 然后通过各种Add方法注册了好多内容进去（收了悟空），然后"),a("span",{staticStyle:{color:"#ff6600"}},[t._v("③"),a("span",{attrs:{"data-mce-":""}},[t._v("foreach ")])]),t._v("之前暂存在configureServicesDelegates中的各个Action，传入services逐一执行， 将之前需要注册的内容注册到services中， 这里就包括Startup（八戒），注意这里仅是进行了注册，而未执行Startup的方法。")])])])]),t._v(" "),a("p",[t._v("处理好的这个services被BuildCommonServices返回后赋值给"),a("span",{staticStyle:{"font-family":"Menlo"}},[t._v(" hostingServices,然后"),a("span",{staticStyle:{"font-family":"Menlo"}},[a("span",{staticStyle:{"font-family":"Menlo"}},[t._v(" hostingServices经过Clone()生成"),a("span",{staticStyle:{"font-family":"Menlo"}},[t._v(" applicationServices,再由这个"),a("span",{staticStyle:{"font-family":"Menlo"}},[t._v(" applicationServices进行"),a("span",{staticStyle:{"font-family":"Menlo"}},[t._v(" GetProviderFromFactory(hostingServices)生成一个"),a("span",{staticStyle:{"font-family":"Menlo",color:"#0000ff"}},[t._v(" IServiceProvider")]),a("span",{staticStyle:{"font-family":"Menlo"}},[t._v(" hostingServiceProvider.经过一系列的处理后,可以创建WebHost了。")])])])])])])])]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")])]),t._v(" host "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[t._v("WebHost")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    applicationServices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    hostingServiceProvider"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    _options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    _config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    hostingStartupErrors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Initialize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("将生成的applicationServices 和 hostingServiceProvider作为参数传递给新生成的WebHost。接下来就是这个WebHost的 Initialize()。")]),t._v(" "),a("h2",{attrs:{id:"_5-webhost-initialize"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-webhost-initialize"}},[t._v("#")]),t._v(" 5. WebHost.Initialize()")]),t._v(" "),a("p",[t._v("WebHost的 Initialize()的主要工作就是BuildApplication()。")]),t._v(" "),a("p",[a("strong",[t._v("EnsureApplicationServices()：")]),t._v(" 用来处理WebHost的 "),a("code",[t._v('<span style="color: #0000ff;">private')]),t._v(" IServiceProvider _applicationServices"),t._v(" ，"),a("span",{staticStyle:{color:"#ff6600"}},[t._v("④Startup的ConfigureServices方法在这里被调用")]),t._v("。")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[t._v("_startup "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" _hostingServiceProvider"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetRequiredService")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("IStartup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n_applicationServices "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" _startup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ConfigureServices")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("_applicationServiceCollection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("通过 "),a("code",[t._v("GetRequiredService<IStartup>()")]),t._v(" 获取到我们的_startup， 然后调用这个_startup的 "),a("span",{staticStyle:{color:"#ff6600"}},[t._v("⑤ConfigureServices")]),t._v(" 方法，这就是我们用于依赖注入的startup类的ConfigureServices方法了。")]),t._v(" "),a("p",[a("span",{staticStyle:{color:"#ff6600"}},[t._v("所以，")]),t._v("_applicationServices是根据_applicationServiceCollection 加上我们在_startup中注册的内容之后重新生成的"),a("span",{staticStyle:{"font-family":"Menlo"}},[t._v(" IServiceProvider。")])]),t._v(" "),a("p",[t._v("**EnsureServer()"),a("span",{staticStyle:{color:"#ff6600"}},[t._v("⑥")]),t._v("：**通过"),a("span",{staticStyle:{"font-family":"Menlo"}},[a("code",[t._v("GetRequiredService<IServer>()")]),t._v("获取Server并配置监听地址。")])]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")])]),t._v(" builderFactory "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" _applicationServices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetRequiredService")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("IApplicationBuilderFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")])]),t._v(" builder "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" builderFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CreateBuilder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Features"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nbuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ApplicationServices "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" _applicationServices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("获取到 IApplicationBuilderFactory并通过它"),a("span",{staticStyle:{color:"#ff6600"}},[t._v("⑦")]),t._v("创建"),a("span",{staticStyle:{"font-family":"Menlo"}},[t._v(" IApplicationBuilder,并将上面创建的")]),t._v("_applicationServices赋值给它的ApplicationServices，它还有个重要的集合_components")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("readonly")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IList"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Func"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("RequestDelegate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" RequestDelegate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" _components "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[t._v("List"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Func"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("RequestDelegate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" RequestDelegate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("从_components的类型可以看出它其实是中间件的集合，是该调用我们的_startup的Configure方法的时候了。")]),t._v(" "),a("p",[t._v("先获取定义的IStartupFilter， "),a("span",{staticStyle:{color:"#ff6600"}},[t._v("⑧")]),t._v("foreach这些IStartupFilter并与_startup的Configure方法一起将配置的中间件写入_components，然后通过 Build()创建RequestDelegate _application，")]),t._v(" "),a("p",[t._v("在Build()中对_components进行处理生成请求处理管道，"),a("span",{staticStyle:{color:"#ff6600"}},[t._v("关于IStartupFilter和生成管道这部分将在下篇文章进行详细说明。")])]),t._v(" "),a("h2",{attrs:{id:"_6-webhost-run"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-webhost-run"}},[t._v("#")]),t._v(" 6. WebHost.Run()")]),t._v(" "),a("p",[t._v("WebHost创建完毕， 最后一步就是Run起来了，WebHost的Run()会调用它的方法StartAsync()")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[t._v("Task")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("StartAsync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CancellationToken")]),t._v(" cancellationToken "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token type-expression class-name"}},[t._v("CancellationToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//......var hostingApp = new HostingApplication(_application, _logger, diagnosticSource, httpContextFactory);")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("StartAsync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hostingApp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cancellationToken"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ConfigureAwait")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    _hostedServiceExecutor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("StartAsync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cancellationToken"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ConfigureAwait")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//.....")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("在之前的文章中我们知道，请求是经过 Server监听=>处理成httpContext=>Application处理，所以这里首先传入上面创建的_application和一个httpContextFactory来"),a("span",{staticStyle:{color:"#ff6600"}},[t._v("⑨生成一个HostingApplication")]),t._v("，并将这个HostingApplication传入Server的StartAsync(), 当Server监听到请求之后， 后面的工作由HostingApplication来完成。")]),t._v(" "),a("p",[a("span",{staticStyle:{color:"#ff6600"}},[t._v("⑩hostedServiceExecutor.StartAsync()")]),t._v("方法用来开启一个后台运行的服务，一些需要后台运行的操作比如定期刷新缓存等可以放到这里来。")]),t._v(" "),a("h2",{attrs:{id:"_7-更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-更新"}},[t._v("#")]),t._v(" 7. 更新")]),t._v(" "),a("p",[t._v("感谢dudu的留言，去github上看了一下WebHost的最新源码，BuildApplication()不再包含EnsureApplicationServices()的调用，并且转移到了WebHost.StartAsync() 中进行； WebHost.Initialize() 中由原本调用BuildApplication()改为调用原本放在BuildApplication()中调用的EnsureApplicationServices()。")]),t._v(" "),a("p",[t._v("通过VS加载符号的方式调试获取到的WebHost仍是原来的版本，即使删除下载的文件后再次重新获取也一样， 应该是和新建项目默认引用的依赖版本有关。")])])}),[],!1,null,null,null);s.default=e.exports}}]);