(window.webpackJsonp=window.webpackJsonp||[]).push([[77],{313:function(s,t,a){"use strict";function n(s,t,a,n,e,r,o,p){var c,v="function"==typeof s?s.options:s;if(t&&(v.render=t,v.staticRenderFns=a,v._compiled=!0),n&&(v.functional=!0),r&&(v._scopeId="data-v-"+r),o?(c=function(s){(s=s||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(s=__VUE_SSR_CONTEXT__),e&&e.call(this,s),s&&s._registeredComponents&&s._registeredComponents.add(o)},v._ssrRegister=c):e&&(c=p?function(){e.call(this,(v.functional?this.parent:this).$root.$options.shadowRoot)}:e),c)if(v.functional){v._injectStyles=c;var _=v.render;v.render=function(s,t){return c.call(t),_(s,t)}}else{var l=v.beforeCreate;v.beforeCreate=l?[].concat(l,c):[c]}return{exports:s,options:v}}a.d(t,"a",(function(){return n}))},442:function(s,t,a){"use strict";a.r(t);var n=a(313),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"二十八-在docker中部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二十八-在docker中部署"}},[s._v("#")]),s._v(" 二十八. 在Docker中部署")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("本文简要说一下ASP.NET Core 在Docker中部署以及docker-compose的使用 。 系统环境为CentOS 8 。")]),s._v(" "),a("h2",{attrs:{id:"_1-概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-概述"}},[s._v("#")]),s._v(" 1. 概述")]),s._v(" "),a("p",[s._v("简单说一下Docker的几个概念：")]),s._v(" "),a("p",[s._v("记得上学的时候流行一种安装操作系统的方式，叫GHOST，大概是这样的：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/blogimages/ASPNETCore_28/548134-20191030205104569-373383123.png",alt:""}})]),s._v(" "),a("p",[s._v("进入PE系统打开GHOST软件，点击“local”,然后选择“Partition”,最后选择“From Image”，选择一个.gho后缀文件，就开始系统安装了。")]),s._v(" "),a("p",[s._v("安装好系统之后，根据自己的需求又安装了一些常用软件，然后为了避免下次重装系统还要安装这些，可以将现在状态的系统再次用GHOST备份一下，生成一个.gho后缀的镜像文件，这个镜像又可以用来安装系统。")]),s._v(" "),a("p",[s._v("一个.gho文件可以用来为多台电脑安装系统，每个被安装好的系统又可以被备份成一个.gho文件文件。")]),s._v(" "),a("p",[s._v("而类比Docker，有这样几个概念：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("Image(镜像)：有点像.gho后缀的镜像文件。")])]),s._v(" "),a("li",[a("p",[s._v("Container(容器)：就像用.gho安装成功的一个操作系统。")])]),s._v(" "),a("li",[a("p",[s._v("Repository(仓库)：存放镜像的仓库，像Git一样可以有公有的仓库也可以有私有的。微软的仓库地址为：")])])]),s._v(" "),a("p",[s._v("但实际上Docker不是一个操作系统，也不像一个虚拟机一样，它是要共享宿主的内核的。")]),s._v(" "),a("p",[s._v("而且一般建议一个容器只跑一个进程，不像操作系统那样可以多进程运行。（虽然也可以通过一些方法在一个Docker容器中跑多个应用，但不建议这样做。）")]),s._v(" "),a("h2",{attrs:{id:"_2-安装docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装docker"}},[s._v("#")]),s._v(" 2. 安装docker")]),s._v(" "),a("p",[a("strong",[s._v("说明：安装CentOS 8 选择了最小安装，此处就不说了，下面说一下Docker的安装过程。")])]),s._v(" "),a("ul",[a("li",[s._v("安装一些必要的系统工具：")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y yum-utils device-mapper-persistent-data lvm2\n")])])]),a("ul",[a("li",[s._v("添加软件源信息：")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n")])])]),a("ul",[a("li",[s._v("更新 yum 缓存：")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" yum makecache fast\n")])])]),a("ul",[a("li",[s._v("安装 Docker-ce：")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" yum -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" docker-ce\n")])])]),a("ul",[a("li",[s._v("启动 Docker 后台服务")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl start docker\n")])])]),a("p",[s._v("注意：安装Docker-ce的时候可能报错：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("package docker-ce …… requires containerd.io "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v(".2-3, but none of the providers can be installed  \n")])])]),a("p",[s._v("是因为containerd.io版本过低，可去下面网站查看新版本：")]),s._v(" "),a("p",[s._v("https://download.docker.com/linux/centos/7/x86_64/edge/Packages")]),s._v(" "),a("ul",[a("li",[s._v("下载：")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://download.docker.com/linux/centos/7/x86_64/edge/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm\n")])])]),a("ul",[a("li",[s._v("安装：")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v(" yum -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" containerd.io-1.2.6-3.3.el7.x86_64.rpm \n")])])]),a("p",[s._v("再次执行sudo yum -y install docker-ce安装即可。")]),s._v(" "),a("h2",{attrs:{id:"_3-docker的几个常见命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-docker的几个常见命令"}},[s._v("#")]),s._v(" 3. Docker的几个常见命令")]),s._v(" "),a("ul",[a("li",[s._v("搜索远程存储库中的镜像，例如MongoDB的镜像")])]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("docker search mongo\n")])])]),a("p",[a("img",{attrs:{src:"/blogimages/ASPNETCore_28/548134-20191031091003819-1071898188.png",alt:""}})]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("拉取仓库中的")]),s._v("镜像")])]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("docker pull  mongo\n")])])]),a("ul",[a("li",[s._v("** **列出本地镜像。")])]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("docker images\n")])])]),a("p",[s._v("可以看到本地镜像中包了mongo镜像。")]),s._v(" "),a("ul",[a("li",[s._v("运行镜像生成一个容器")])]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("docker run "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("name mongotodocker "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27088")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("d mongo\n")])])]),a("p",[s._v("含义: 用镜像mongo运行生成一个容器，名字为mongotodocker ，将容器内的端口27017映射到主机的27088端口。-p 指的是端口映射。 -d是说后台运行容器，并返回容器ID；")]),s._v(" "),a("ul",[a("li",[s._v("** 列出所有容器**。")])]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("docker ps "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("a\n")])])]),a("p",[s._v("可以看到刚运行起来的容器。")]),s._v(" "),a("ul",[a("li",[s._v("停止容器")])]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("docker stop mongotodocker\n")])])]),a("ul",[a("li",[s._v("** 删除容器**。")])]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("docker rm mongotodocker\n")])])]),a("ul",[a("li",[s._v("删除镜像")])]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("docker rmi mongo\n")])])]),a("p",[s._v("具体每个命令都有一些参数可用，这里只是简单介绍一下使用方法。具体的文档网上很多，不一一说明了。")]),s._v(" "),a("h2",{attrs:{id:"_4-注册docker账号"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-注册docker账号"}},[s._v("#")]),s._v(" 4. 注册Docker账号")]),s._v(" "),a("p",[s._v("注册一个账号（可选项），地址："),a("a",{attrs:{href:"https://hub.docker.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://hub.docker.com/"),a("OutboundLink")],1),s._v(" ，可以在上面建自己的仓库。")]),s._v(" "),a("h2",{attrs:{id:"_5-创建一个asp-net-core-项目-生成并运行docker镜像"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-创建一个asp-net-core-项目-生成并运行docker镜像"}},[s._v("#")]),s._v(" 5. 创建一个ASP.NET Core 项目，生成并运行Docker镜像")]),s._v(" "),a("p",[s._v("新建一个名为DockerComposeDemo的API项目，直接发布，拷贝发布的文件到CentOS系统中，例如/home/aspcore目录。并在该目录新建一个文本文件名为Dockerfile，内容如下：")]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("FROM mcr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("microsoft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dotnet"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("core"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("aspnet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("buster"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("slim AS "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("base")]),s._v("\n    WORKDIR "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("app\n    EXPOSE "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n    COPY "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    ENTRYPOINT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dotnet"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"DockerComposeDemo.dll"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),a("p",[s._v("含义是：引用包含3.0运行时的镜像，这个镜像在远程仓库中，若本地没有提前pull下来，会先执行pull操作获取到本地。然后将工作目录设为/app ， 拷贝发布的项目文件，设置进程的入口是通过dotnet运行DockerComposeDemo.dll。")]),s._v(" "),a("p",[s._v("执行如下命令：")]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("cd "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("aspcore\n    docker build "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("t dockertest "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),a("p",[s._v("注意第二行后后面有个'.'不能少。 含义就是按照Dockerfile文件中设置的规则生成名为dockertest的镜像。")]),s._v(" "),a("p",[s._v("此时执行docker images命令可以看到本地镜像中已经有了 "),a("code",[s._v('mcr.microsoft.com/dotnet/core/aspnet:<span style="color: #800080;">3.0')]),s._v("-buster-slim"),s._v(" 和 "),a("code",[s._v("dockertest")]),s._v(" 两个镜像。")]),s._v(" "),a("p",[s._v("运行这个镜像生成容器：")]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("docker run "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("name aspdocker "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("d dockertest\n")])])]),a("p",[s._v("生成一个名为aspdocker 的容器，并将容器的80端口映射到主机的8080端口。访问项目默认提供的controller："),a("a",{attrs:{href:"http://192.168.183.230:8080/WeatherForecast",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://192.168.183.230:8080/WeatherForecast"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("可以看到能正常访问。")]),s._v(" "),a("h2",{attrs:{id:"_6-使用docker-compose"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-使用docker-compose"}},[s._v("#")]),s._v(" 6. 使用docker-compose")]),s._v(" "),a("p",[s._v("因为一个Docker容器只建议运行一个应用，那么一个项目就可能会存在多个容器被运行，可能包含多个项目、数据库等，这时候就需要对这些容器进行统一的管理，从构建运行开始到运行后状态的监控等。")]),s._v(" "),a("p",[s._v("这时候有个简易的方法就是docker-compose，它可以完成多个Docker的统一管理，包括Docker镜像构建、容器运行、相关配置以及Docker之间的依赖关系等。")]),s._v(" "),a("p",[s._v("下面举个简单例子，这个DockerComposeDemo项目需要搭配一个MongoDB数据库，这样除了该项目外还需要一个Docker容器运行MongoDB数据库。")]),s._v(" "),a("p",[s._v("这时候用docker-compose就方便多了。docker-compose的核心是"),a("a",{attrs:{href:"https://github.com/FlyLolo/SomeDockerDemo/blob/master/DockerComposeDemo/docker-compose.yml",title:"docker-compose.yml",target:"_blank",rel:"noopener noreferrer"}},[s._v("docker-"),a("OutboundLink")],1),s._v("compose.yml文件，看一下对应这个例子的文件内容：")]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("version"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" '"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.4")]),s._v("'\n\n    services"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      demomvc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        image"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("thisdemoimage")]),s._v("\n        build"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n          dockerfile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Dockerfile")]),s._v("\n        environment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" ASPNETCORE_DBCONN"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mongodb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".183")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".230")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27089")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" ASPNETCORE_DBNAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("dockerdb")]),s._v("\n\n        ports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5103:80"')]),s._v("\n        depends_on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("mongodocker")]),s._v("\n      mongodocker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        image"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("mongo")]),s._v("\n        ports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"27089:27017"')]),s._v("\n")])])]),a("p",[s._v("在services节点下定义了demomvc和mongodocker两个服务，一个是ASP.NET Core的项目，一个是MongoDB数据库。")]),s._v(" "),a("p",[s._v("每个节点下的image参数指定了采用的镜像名称，ports指定端口映射。"),a("strong",[s._v("此处的MongoDB设置未涉及持久化，实际使用时要注意设置。")])]),s._v(" "),a("p",[s._v("ASP.NET Core的项目的thisdemoimage镜像是不存在的，下面指定了build方法。"),a("strong",[s._v("当然也可以先创建好镜像然后在这里使用就像mongo服务的设置一样。")])]),s._v(" "),a("p",[s._v("depends_on表示本服务对另一个服务的依赖，本例中就是ASP.NET Core项目依赖MongoDB项目。")]),s._v(" "),a("p",[s._v("environment用于设置环境变量，作用是什么呢？")]),s._v(" "),a("p",[s._v("有一些设置，比如本例中的数据库连接，如果将连接字符串写在了项目中的appsettings.json中，而这个文件被“固化”到镜像中了，是不能修改的，除非重新生成镜像，非常麻烦。")]),s._v(" "),a("p",[s._v("所以可以通过这样的环境变量在外面设置。")]),s._v(" "),a("p",[s._v("将项目引用NuGet包MongoDB.Driver, 修改WeatherForecastController的get方法：")]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HttpGet")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s._v("IEnumerable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("WeatherForecast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")])]),s._v(" rng "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[s._v("Random")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                _mongoHelper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("InsertOne")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[s._v("WeatherForecast")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    Date "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" DateTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("AddDays")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                    TemperatureC "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" rng"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("55")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                    Summary "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Summaries"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rng"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Summaries"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" _mongoHelper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("FindList")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("WeatherForecast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("每次都是先插入一条，然后返回所有记录。这里简要的写了一个mongoHelper：")]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MongoHelper")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("readonly")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IMongoDatabase")]),s._v(" database"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("MongoHelper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IConfiguration")]),s._v(" configuration"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("configuration"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ASPNETCORE_DBCONN"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" configuration"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetSection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ASPNETCORE_DBNAME"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("MongoHelper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("string")])]),s._v(" ConnectionString"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("string")])]),s._v(" DBName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MongoClient")]),s._v(" mongoClient "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[s._v("MongoClient")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ConnectionString"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                database "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mongoClient"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetDatabase")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("DBName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s._v("List"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("T"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("FindList")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("T"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FilterDefinition"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("T"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" filter "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("string")])]),s._v(" collectionName "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                collectionName "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("??=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token type-expression class-name"}},[s._v("T")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                filter "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("??=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[s._v("BsonDocument")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")])]),s._v(" collection "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" database"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetCollection")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("T"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("collectionName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" collection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Find")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("filter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ToList")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("InsertOne")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("T"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" model"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("string")])]),s._v(" collectionName "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                collectionName "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("??=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token type-expression class-name"}},[s._v("T")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")])]),s._v(" collection "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" database"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetCollection")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("T"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("collectionName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                collection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("InsertOne")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("连接字符串采用 IConfiguration中的设置。")]),s._v(" "),a("p",[a("strong",[s._v("这里有个不算技巧的技巧，为了方便在非Docker的情况下测试，依然可以在appsettings.json文件中设置MongoDB的连接字符串，当部署到Docker中的时候，通过Docker环境变量配置的连接字符串会覆盖appsettings.json中的配置。")])]),s._v(" "),a("p",[a("strong",[s._v("这是因为在讲述IConfiguration的文章中说过，系统是先加载appsettings.json中的设置，后加载环境变量中的设置的，二者的key相同，所以最终会以环境变量中的配置为准。")])]),s._v(" "),a("p",[s._v("重新发布项目并将文件拷贝到/home/aspcore目录，其中的dockerfile文件不变，添加本例中的docker-compose.yml文件。")]),s._v(" "),a("p",[s._v("docker-compose是需要单独下载安装的, 执行命令:")]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("sudo curl "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("L "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bin"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docker"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("compose\n")])])]),a("p",[s._v("如果提示权限错误，需执行如下命令：")]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("sudo chmod "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("x "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bin"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docker"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("compose\n")])])]),a("p",[s._v("安装好之后执行 "),a("code",[s._v("docker-compose --version")]),s._v(" 验证是否安装成功。")]),s._v(" "),a("p",[s._v("都准备好了，执行如下命令：")]),s._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[s._v("cd "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("aspcore\n    docker"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("compose up\n")])])]),a("p",[s._v("执行成功后访问 "),a("a",{attrs:{href:"http://192.168.183.230:8080/WeatherForecast",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://192.168.183.230:5103/WeatherForecast"),a("OutboundLink")],1),s._v(" 进行测试。")]),s._v(" "),a("h2",{attrs:{id:"_7-windows下开发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-windows下开发"}},[s._v("#")]),s._v(" 7. Windows下开发")]),s._v(" "),a("p",[s._v("我们都知道，VisualStudio经常“贴心”的帮我们做好多事，例如Git的图形化操作。对于Docker也是如此。")]),s._v(" "),a("p",[a("strong",[s._v("若要在Windows环境下开发及调试Docker，可按下面步骤完成。")])]),s._v(" "),a("p",[s._v("首先需下载并安装"),a("strong",[s._v("Docker Desktop")])]),s._v(" "),a("p",[s._v("页面上有个图标："),a("img",{attrs:{src:"/blogimages/ASPNETCore_28/548134-20191030162140868-695504147.png",alt:""}}),s._v("，点击下载。安装"),a("img",{attrs:{src:"/blogimages/ASPNETCore_28/548134-20191030162206079-358902424.png",alt:""}}),s._v("后右下角会有 图标，右键可以做一些设置。")]),s._v(" "),a("p",[s._v("它支持Windows和Linux两种主机")]),s._v(" "),a("p",[s._v("通过docker version 命令可以看出当前主机类型。也可以右键点击右下角的图标，有个Switch to ……的选项，可以知道当前主机类型，点击后切换到另一种类型。")]),s._v(" "),a("p",[s._v("命令切换：C:\\Program Files\\Docker\\Docker\\DockerCli.exe -SwitchDaemon")]),s._v(" "),a("p",[a("strong",[s._v("解决方案启用Docker支持：")])]),s._v(" "),a("p",[s._v("新建项目的时候，勾选启用Docker支持：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/blogimages/ASPNETCore_28/548134-20191030171135510-1776092839.png",alt:""}})]),s._v(" "),a("p",[s._v("已有项目可以右键点击项目，添加Docker支持：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/blogimages/ASPNETCore_28/548134-20191030171202301-805548079.png",alt:""}})]),s._v(" "),a("p",[s._v("两种方式都会要求选择主机类型是Windows还是Linux。")]),s._v(" "),a("p",[s._v("此时Visual Studio帮我们会在项目中添加一个名为Dockerfile的文件：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("FROM mcr.microsoft.com/dotnet/core/aspnet:3.0-buster-slim AS base\n    WORKDIR /app\n    EXPOSE "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n\n    FROM mcr.microsoft.com/dotnet/core/sdk:3.0-buster AS build\n    WORKDIR /src\n    COPY "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"DockerDemo/DockerDemo.csproj"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"DockerDemo/"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    RUN dotnet restore "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"DockerDemo/DockerDemo.csproj"')]),s._v("\n    COPY "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n    WORKDIR "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/src/DockerDemo"')]),s._v("\n    RUN dotnet build "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"DockerDemo.csproj"')]),s._v(" -c Release -o /app/build\n\n    FROM build AS publish\n    RUN dotnet publish "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"DockerDemo.csproj"')]),s._v(" -c Release -o /app/publish\n\n    FROM base AS final\n    WORKDIR /app\n    COPY --from"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("publish /app/publish "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n    ENTRYPOINT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dotnet"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"DockerDemo.dll"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),a("p",[s._v("这个文件和上面例子中我们自己创建的优点不同，它包含了4个From，第一个和最后一个和我们自己创建的有点像，只是Visual Studio帮我们自动添加了SDK镜像的拉取、项目的编译、项目发布的过程。")]),s._v(" "),a("p",[s._v("这里用到了两个镜像，第一个From调用了微软官方的包含ASP.NET Core 3.0 的运行时版镜像。第二个From用到了包含.Net Core 3.0的SDK的镜像，因为我们需要对项目进行生成和发布操作。")]),s._v(" "),a("p",[s._v("通过添加Docker的支持，可以使用Visual Studio开发并将项目自动发布到Docker进行调试。但选择系统环境为Windows的时候速度很快，选择Linux的时候由于网络问题非常慢。网上有临时的解决方案。")]),s._v(" "),a("p",[s._v("如果多个项目想采用docker-compose管理，在上面添加docker支持的图中可以看到有一个“容器业务流程协调程序支持”， 添加它就会自动生成一个docker-compose.yml文件。")]),s._v(" "),a("p",[s._v("Docker-Compose主要用于当前主机中的docker的管理，对于多主机的集群管理，就需要Docker Swarm或者Kubernetes了。")])])}),[],!1,null,null,null);t.default=e.exports}}]);