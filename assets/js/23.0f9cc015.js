(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{531:function(s,t,n){"use strict";n.r(t);var a=n(7),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("在大部分程序中一般都会需要用到后台任务， 比如定时更新缓存或更新某些状态。")]),s._v(" "),n("h2",{attrs:{id:"_1-应用场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-应用场景"}},[s._v("#")]),s._v(" 1. 应用场景")]),s._v(" "),n("p",[s._v("以调用微信公众号的Api为例， 经常会用到access_token，官方文档这样描述：“是公众号的全局唯一接口调用凭据，有效期目前为2个小时，需定时刷新，重复获取将导致上次获取的access_token失效，建议公众号开发者使用中控服务器统一获取和刷新Access_token，其他业务逻辑服务器所使用的access_token均来自于该中控服务器，不应该各自去刷新，否则容易造成冲突，导致access_token覆盖而影响业务。”")]),s._v(" "),n("p",[s._v("在这个场景中我们可以创建一个后台运行的服务，按照access_token的有效期定时执行去请求获取新的access_token并存储，其他所有需要用到这个access_token的都到这个共有的access_token。")]),s._v(" "),n("h2",{attrs:{id:"_2-实现方式-一"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-实现方式-一"}},[s._v("#")]),s._v(" 2. 实现方式（一）")]),s._v(" "),n("p",[s._v("ASP.NET Core 在2.0的时候就提供了一个名为IHostedService的接口，我们要做的只有两件事：")]),s._v(" "),n("ol",[n("li",[s._v("实现它。")])]),s._v(" "),n("p",[n("span",{staticStyle:{color:"#ff6600"}},[s._v("2. 将这个接口实现注册到依赖注入服务中。")])]),s._v(" "),n("p",[s._v("A. 实现IHostedService的接口")]),s._v(" "),n("p",[s._v("首先看一下这个IHostedService：")]),s._v(" "),n("div",{staticClass:"language-csharp line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-csharp"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("interface")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IHostedService")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s._v("Task")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("StartAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CancellationToken")]),s._v(" cancellationToken"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s._v("Task")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("StopAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CancellationToken")]),s._v(" cancellationToken"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("通过名字就可以看出来，一个是这个服务启动的时候做的操作，另一个则是停止的时候。")]),s._v(" "),n("p",[s._v("新建一个类 "),n("code",[s._v("TokenRefreshService")]),s._v(" 实现 "),n("code",[s._v("IHostedService")]),s._v(" ，如下面代码所示：")]),s._v(" "),n("div",{staticClass:"language-csharp line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-csharp"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("internal")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TokenRefreshService")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IHostedService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" IDisposable\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("readonly")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ILogger")]),s._v(" _logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Timer")]),s._v(" _timer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("TokenRefreshService")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ILogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("TokenRefreshService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("             _logger "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s._v("Task")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("StartAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CancellationToken")]),s._v(" cancellationToken"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v("             _logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("LogInformation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Service starting"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("             _timer "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[s._v("Timer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Refresh"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" TimeSpan"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Zero"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("TimeSpan"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("FromSeconds")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CompletedTask"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token return-type class-name"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")])]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Refresh")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("object")])]),s._v(" state"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("             _logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("LogInformation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("DateTime"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Now"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ToLongTimeString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('": Refresh Token!"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//在此写需要执行的任务")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("             \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s._v("Task")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("StopAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CancellationToken")]),s._v(" cancellationToken"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v("             _logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("LogInformation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Service stopping"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v("             _timer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?.")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Change")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Timeout"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Infinite"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CompletedTask"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token return-type class-name"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")])]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Dispose")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),s._v("             _timer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?.")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Dispose")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])]),n("p",[s._v("既然是定时刷新任务，那么就用了一个timer， 当服务启动的时候启动它，由它定时执行Refresh方法来获取新的Token。")]),s._v(" "),n("p",[n("span",{staticStyle:{color:"#ff6600"}},[s._v("这里为了方便测试写了5秒执行一次， 实际应用还是读取配置文件比较好")]),s._v("， 结果如下：")]),s._v(" "),n("div",{staticClass:"language-csharp line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-csharp"}},[n("code",[s._v("BackService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TokenRefreshService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("Information"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Refresh Token"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\nBackService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TokenRefreshService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("Information"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Refresh Token"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\nBackService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TokenRefreshService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("Information"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Refresh Token"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\nBackService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TokenRefreshService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("Information"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Refresh Token"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\nBackService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TokenRefreshService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("Information"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Refresh Token"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("B. 在依赖注入中注册这个服务。")]),s._v(" "),n("p",[s._v("在Startup的ConfigureServices中注册这个服务，如下代码所示：")]),s._v(" "),n("div",{staticClass:"language-csharp line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-csharp"}},[n("code",[s._v("services"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token generic-method"}},[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("AddSingleton")]),n("span",{pre:!0,attrs:{class:"token generic class-name"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("IHostedService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" TokenRefreshService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h2",{attrs:{id:"_3-实现方式-二"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-实现方式-二"}},[s._v("#")]),s._v(" 3. 实现方式（二）")]),s._v(" "),n("p",[s._v("在 ASP.NET Core 2.1中， 提供了一个名为 "),n("code",[s._v("BackgroundService")]),s._v(" 的类，它在 "),n("code",[s._v("Microsoft.Extensions.Hosting")]),s._v(" 命名空间中，查看一下它的源码：")]),s._v(" "),n("div",{staticClass:"language-csharp line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-csharp"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("using")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("using")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("System"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Threading")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("using")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("System"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Threading"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Tasks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("namespace")]),s._v(" Microsoft"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Extensions"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Hosting\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/// <summary>")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('/// Base class for implementing a long running <see cref="IHostedService"/>.')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/// </summary>")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("abstract")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BackgroundService")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IHostedService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" IDisposable\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Task")]),s._v(" _executingTask"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("readonly")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CancellationTokenSource")]),s._v(" _stoppingCts "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[s._v("CancellationTokenSource")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/// <summary>")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('/// This method is called when the <see cref="IHostedService"/> starts. The implementation should return a task that represents')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/// the lifetime of the long running operation(s) being performed.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/// </summary>")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('/// <param name="stoppingToken">Triggered when <see cref="IHostedService.StopAsync(CancellationToken)"/> is called.</param>')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('/// <returns>A <see cref="Task"/> that represents the long running operations.</returns>')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("protected")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("abstract")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s._v("Task")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ExecuteAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CancellationToken")]),s._v(" stoppingToken"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/// <summary>")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/// Triggered when the application host is ready to start the service.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/// </summary>")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('/// <param name="cancellationToken">Indicates that the start process has been aborted.</param>')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("virtual")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s._v("Task")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("StartAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CancellationToken")]),s._v(" cancellationToken"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Store the task we're executing")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("             _executingTask "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ExecuteAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("_stoppingCts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// If the task is completed then return it, this will bubble cancellation and failure to the caller")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("_executingTask"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("IsCompleted"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),s._v("                 "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" _executingTask"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("36")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("37")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("38")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Otherwise it's running")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("39")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CompletedTask"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/// <summary>")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("43")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/// Triggered when the application host is performing a graceful shutdown.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/// </summary>")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('/// <param name="cancellationToken">Indicates that the shutdown process should no longer be graceful.</param>')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("46")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("virtual")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s._v("Task")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("StopAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CancellationToken")]),s._v(" cancellationToken"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("47")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Stop called without start")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("49")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("_executingTask "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("                 "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("53")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("54")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("55")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),s._v("                 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Signal cancellation to the executing method")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("57")]),s._v("                 _stoppingCts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Cancel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("58")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("59")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("finally")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("61")]),s._v("                 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Wait until the task completes or the stop token triggers")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("62")]),s._v("                 "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("WhenAny")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("_executingTask"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Delay")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Timeout"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Infinite"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cancellationToken"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("63")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("65")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("66")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("virtual")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token return-type class-name"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")])]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Dispose")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("67")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("68")]),s._v("             _stoppingCts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Cancel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("69")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("70")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br")])]),n("p",[s._v("可以看出它一样是继承自 "),n("code",[s._v("IHostedService, IDisposable")]),s._v(" ， 它相当于是帮我们写好了一些“通用”的逻辑， 而我们只需要继承并实现它的 "),n("code",[s._v("ExecuteAsync")]),s._v(" 即可。")]),s._v(" "),n("p",[s._v("也就是说，我们只需在这个方法内写下这个服务需要做的事，这样上面的刷新Token的Service就可以改写成这样：")]),s._v(" "),n("div",{staticClass:"language-csharp line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-csharp"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("internal")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TokenRefreshService")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" BackgroundService\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("readonly")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ILogger")]),s._v(" _logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("TokenRefreshService")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ILogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("TokenRefresh2Service"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("             _logger "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("protected")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("override")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s._v("Task")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ExecuteAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CancellationToken")]),s._v(" stoppingToken"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("             _logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("LogInformation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Service starting"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("stoppingToken"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("IsCancellationRequested"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("                 _logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("LogInformation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("DateTime"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Now"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ToLongTimeString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('": Refresh Token!"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//在此写需要执行的任务")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v("                 "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Delay")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" stoppingToken"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("             _logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("LogInformation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Service stopping"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[s._v("是不是简单了不少。"),n("span",{staticStyle:{color:"#ff6600"}},[s._v("（同样这里为了方便测试写了5秒执行一次）")])]),s._v(" "),n("h1",{attrs:{id:"四-注意事项"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四-注意事项"}},[s._v("#")]),s._v(" "),n("span",{staticStyle:{color:"#000000"}},[n("span",{staticStyle:{color:"#005000"}},[s._v("四. 注意事项")])])]),s._v(" "),n("p",[s._v("感谢"),n("a",{attrs:{href:"https://www.cnblogs.com/FlyLolo/p/ASPNETCore2_11.html#4006845",title:"查看所回复的评论",target:"_blank",rel:"noopener noreferrer"}},[s._v("@"),n("OutboundLink")],1),s._v(" 咿呀咿呀哟在评论中的提醒，当项目部署在IIS上的时候， 当应用程序池回收的时候，这样的后台任务也会停止执行。")]),s._v(" "),n("p",[s._v("经测试：")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("当IIS上部署的项目启动后，后台任务随之启动，任务执行相应的log正常输出。")])]),s._v(" "),n("li",[n("p",[s._v("手动回收对应的应用程序池，任务执行相应的log输出停止。")])]),s._v(" "),n("li",[n("p",[s._v("重新请求该网站，后台任务随之启动，任务执行相应的log重新开始输出。")])])]),s._v(" "),n("p",[s._v("所以不建议在这样的后台任务中做一些需要固定定时执行的业务处理类的操作，但对于缓存刷新类的操作还是可以的，因为当应用程序池回收后再次运行的时候，后台任务会随着启动。")]),s._v(" "),n("p",[n("a",{attrs:{href:"https://github.com/FlyLolo/BackgroundServiceAndNlog",target:"_blank",rel:"noopener noreferrer"}},[s._v("github"),n("OutboundLink")],1),s._v("地址")])])}),[],!1,null,null,null);t.default=e.exports}}]);